$(document).ready(function () {
  // We listen to the resize event

  let vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
  window.addEventListener('resize', () => {
    // We execute the same script as before
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
  });
  console.log(vh);

  // box slider
  $('.slidermenu__items').bxSlider();


  // fullscreen menu

  const hamburgerMenu = document.querySelector(".hamburger-menu-link");
  const fullScreenMenu = document.querySelector(".fullscreen-menu");
  const fullScreenMenuClose = document.querySelector(".fullscreen-menu__close");

  hamburgerMenu.addEventListener("click", function (e) {
    e.preventDefault();
    fullScreenMenu.style.display = "flex";
  });

  fullScreenMenuClose.addEventListener("click", function (e) {
    e.preventDefault();
    fullScreenMenu.style.display = "none";
  });

  $(".menu__link").on('click', e => {
    $(fullScreenMenu).css({ 'display': 'none' });
  })



  // team section
  let teamItems = $('.team__item');
  let teamItemLink = $('.team__link');

  $('.team__link').on('click', (e) => {
    e.preventDefault();

    $(e.currentTarget).closest('.team__item').toggleClass('team__item--active');
    $(e.currentTarget).closest('.team__item').siblings('.team__item').removeClass('team__item--active');
  })

  //burger menu

  $('.burgermenu__trigger').on('click', e => {
    e.preventDefault();

    $(e.currentTarget).closest('.burgermenu__item').toggleClass('burgermenu__item--active');
    $(e.currentTarget).closest('.burgermenu__item').siblings('.burgermenu__item').removeClass('burgermenu__item--active');
  })

  $('.burgermenu__close').on('click', e => {
    e.preventDefault();

    $('.burgermenu__trigger').click();
  });
  // order menu

  const orderForm = document.querySelector('.orderForm');
  const orderBtn = document.querySelector('#order__btn');

  orderBtn.addEventListener('click', (e) => {
    e.preventDefault();
    // console.log(orderForm.elements.name.value);
    if (validateForm(orderForm)) {
      // console.log('vsew ok');
      const data = {
        name: orderForm.elements.name.value,
        phone: orderForm.elements.phone.value,
        comment: orderForm.elements.comment.value,
        to: 'some-mail@mail.com' // По заданию сервер принимает четыре параметра, включая email. 
        // Но по макету в форме email он отсутствует.
      }
      const xhr = new XMLHttpRequest();
      xhr.responseType = 'json';
      xhr.open('POST', 'https://webdev-api.loftschool.com/sendmail');
      xhr.setRequestHeader('content-type', 'application/json');
      xhr.send(JSON.stringify(data));
      xhr.addEventListener('load', () => {
        console.log(xhr.response.message);
        overlayOrder.open();
        overlayOrder.setContent(xhr.response.message);
      });
    }
  });

  function validateForm(form) {
    let valid = true;

    if (!validateField(form.elements.name)) {
      valid = false;
    }

    if (!validateField(form.elements.phone)) {
      valid = false;
    }

    if (!validateField(form.elements.comment)) {
      valid = false;
    }

    return valid;
  }

  function validateField(field) {
    // field.nextElementSibling.textContent = field.validationMessage;
    if (field.checkValidity()) {
      $(field).css('border-color', 'transparent');
    } else {
      $(field).css('border-color', 'red');
    }
    return field.checkValidity();
  }


  //overlay

  // const openOverlay = document.querySelector('#openOverlay');
  const tamplateOrder = document.querySelector('#overlayOrder').innerHTML;
  const overlayOrder = createOverlay(tamplateOrder, 'tamplateOrder');

  // openOverlay.addEventListener('click', e => {
  //   overlay.open();
  //   overlay.setContent('Vse ok');
  // });

  function createOverlay(tamplate, classTamplate) {
    const fragment = document.createElement('div');
    fragment.innerHTML = tamplate;

    const overlayElement = fragment.querySelector('.overlay');
    const containerElement = fragment.querySelector('.overlay__container');
    containerElement.classList.add(classTamplate);
    const closeElement = fragment.querySelector('.overlay__close');
    const contentElement = fragment.querySelector('.overlay__content');

    overlayElement.addEventListener('click', e => {
      if (e.target === overlayElement) {
        closeElement.click();
      }
    });

    closeElement.addEventListener('click', (e) => {
      e.preventDefault();
      document.body.removeChild(overlayElement);
    })

    return {
      open() {
        document.body.appendChild(overlayElement);
      },
      close() {
        closeElement.click();
      },
      setContent(content) {
        contentElement.innerHTML = content;
      }
    }

  }

  // reviews 
  const tamplateReview = document.querySelector('#overlayReview').innerHTML;
  const overlayReview = createOverlay(tamplateReview);

  const reviewOverlayBtn = $('.review__btn');

  reviewOverlayBtn.on('click', e => {
    e.preventDefault();
    let reviewContent = $(e.currentTarget).siblings('.review__content').prop('outerHTML');

    overlayReview.open();
    overlayReview.setContent(reviewContent);
  })

  //one page scroll
  const sections = $('.section');
  const display = $('.maincontent');

  let inScroll = false; // есть ли перемещение


  const countSectionPosition = (sectionIndex) => {
    const position = sectionIndex * (-100);
    // console.log(position);
    if (isNaN(position)) {
      console.error("передано не верное значение в countSectionPositon");
    }
    return position;

  }

  const resetActiveClass = function (section, sectionIndex) {
    section.eq(sectionIndex).addClass('active').siblings().removeClass('active');
    $('.fixed-menu__item').eq(sectionIndex).addClass('active').siblings().removeClass('active');
  };

  const performTransition = (sectionIndex) => {
    if (inScroll) return; // проверяем , есть ли перемещение сейчас
    inScroll = true; //разрешаем перемещение
    //определяем позицию секции и расчитываем значение перемещения
    const position = countSectionPosition(sectionIndex);
    const trasitionOver = 500; // время задержки

    //меняем активный класс
    resetActiveClass(sections, sectionIndex);

    //перемещяем maincontent на указанную позицию
    display.css({
      transform: `translateY(${position}%)`,
    });

    //устанавливаем время задержки
    setTimeout(() => {
      inScroll = false; //запрещяем перемещение
      // resetActiveClass($(".fixed-menu__item"), sectionEq);
    }, trasitionOver);

  }

  const pageScroll = function () {
    const activeSection = sections.filter('.active');
    const nextSection = activeSection.next();
    const prevSection = activeSection.prev();

    return {
      next() {
        // есть ли секция снизу
        if (nextSection.length) {
          performTransition(nextSection.index());
        }
      },
      prev() {
        // есть ли секция сверху
        if (prevSection.length) {
          performTransition(prevSection.index());
        }
      }
    }

  };

  //обработка событий: 

  $(document).keydown(e => {
    const targetName = e.target.tagName.toLowerCase();
    const windowScroller = pageScroll();

    if (targetName === 'body') {

      if (e.key === "ArrowDown") {
        // console.log('arrow down');
        windowScroller.next();
      } else if (e.key === "ArrowUp") {
        windowScroller.prev();
        // console.log('arrow up');
      } else if (e.keyCode === 32) {
        // console.log("space");
        windowScroller.next();
      }
    }
  });

  $('[scroll-to]').on('click', (e) => {
    e.preventDefault();
    // console.log(e.currentTarget);
    let menuIndex = $(e.currentTarget).attr('scroll-to');
    performTransition(menuIndex);
  });

  $(window).on("wheel", (e) => {
    const deltaY = e.originalEvent.deltaY;
    const windowScroller = pageScroll();

    if (deltaY > 0) {
      windowScroller.next();
    }

    if (deltaY < 0) {
      windowScroller.prev();
    }
  });

  $('.scroll-down').on('click', e => {
    e.preventDefault();
    performTransition(1);
  });



  /// http://hgoebl.github.io/mobile-detect.js/
  const md = new MobileDetect(window.navigator.userAgent);
  const isMobile = md.mobile();
  // console.log(isMobile);

  if (isMobile) {
    // http://github.com/mattbryson/TouchSwipe-Jquery-Plugin
    $("body").swipe({
      //Generic swipe handler for all directions
      swipe: function (event, direction, distance, duration, fingerCount, fingerData) {
        // console.log("You swiped " + direction );
        const windowScroller = pageScroll();

        if (direction === 'up') {
          // console.log('up');
          windowScroller.next();
        }

        if (direction === 'down') {
          // console.log('down');
          windowScroller.prev();
        }
      }
    });
  }
  //

  //

  // yandex map
  let myMap;
  const init = () => {
    myMap = new ymaps.Map("map", {
      center: [59.938951, 30.315635],
      zoom: 11,
      controls: []
    });
    const coords = [
      [59.888834, 30.321793],
      [59.936620, 30.259454],
      [59.931454, 30.345764],
      [59.861381, 30.398845],
    ];
    const myCollection = new ymaps.GeoObjectCollection({}, {
      draggable: false,
      iconLayout: 'default#image',
      iconImageHref: './img/icons/map-marker.svg',
      iconImageSize: [46, 57],
      iconImageOffset: [-35, -52]
    });

    coords.forEach(coord => {
      myCollection.add(new ymaps.Placemark(coord));
    })

    myMap.geoObjects.add(myCollection);
    myMap.behaviors.disable('scrollZoom');
  };


  ymaps.ready(init);


}); //document ready


/// youtube player

let player;
const playerContainer = $(".player");

let eventsInit = () => {
  $(".player__start").click(e => {
    e.preventDefault();

    if (playerContainer.hasClass("paused")) {
      player.pauseVideo();
      console.log(player);

    } else {
      player.playVideo();
    }
  });

  $(".player__playback").click(e => {
    const bar = $(e.currentTarget);
    const clickedPosition = e.originalEvent.layerX;
    const newButtonPositionPercent = (clickedPosition / bar.width()) * 100;
    const newPlaybackPositionSec =
      (player.getDuration() / 100) * newButtonPositionPercent;

    $(".player__playback-button").css({
      left: `${newButtonPositionPercent}%`
    });

    player.seekTo(newPlaybackPositionSec);
  });

  $(".player__splash").click(e => {
    player.playVideo();
  })

  $(".player__volume-button").click(e => {
    if (player.isMuted()) {
      player.unMute();
      $(e.currentTarget).parent().removeClass("mute");
      $('.player__volume-level-button').css({
        left: `${(player.getVolume())}%`
      });
    } else {
      player.mute();
      $(e.currentTarget).parent().addClass("mute");
      $('.player__volume-level-button').css({
        left: 0
      });
    }
  });

  $('.player__volume-level').click(e => {
    const volumeLevel = $(e.currentTarget);
    const volumeLevelClickPosition = e.originalEvent.layerX;
    const newVolumeLevel = (volumeLevelClickPosition / volumeLevel.width()) * 100;
    player.setVolume(newVolumeLevel);

    if (newVolumeLevel === 0) {
      player.mute();
      $(".player__volume").addClass("mute");
      $('.player__volume-level-button').css({
        left: 0
      });
    } else {
      player.unMute();
      $(".player__volume").removeClass("mute");
      $('.player__volume-level-button').css({
        left: `${newVolumeLevel}%`
      });
    }
    // const newVolumeLevel = (player.getVolume())


  });
};

const formatTime = timeSec => {
  const roundTime = Math.round(timeSec);

  const minutes = addZero(Math.floor(roundTime / 60));
  const seconds = addZero(roundTime - minutes * 60);

  function addZero(num) {
    return num < 10 ? `0${num}` : num;
  }

  return `${minutes} : ${seconds}`;
};

const onPlayerReady = () => {
  let interval;
  const durationSec = player.getDuration();

  $(".player__duration-estimate").text(formatTime(durationSec));

  if (typeof interval !== "undefined") {
    clearInterval(interval);
  }

  interval = setInterval(() => {
    const completedSec = player.getCurrentTime();
    const completedPercent = (completedSec / durationSec) * 100;

    $(".player__playback-button").css({
      left: `${completedPercent}%`
    });

    $(".player__duration-completed").text(formatTime(completedSec));
  }, 1000);
};

const onPlayerStateChange = event => {
  /*
    -1 (воспроизведение видео не начато)
    0 (воспроизведение видео завершено)
    1 (воспроизведение)
    2 (пауза)
    3 (буферизация)
    5 (видео подают реплики).
  */
  switch (event.data) {
    case 1:
      playerContainer.addClass("active");
      playerContainer.addClass("paused");
      break;

    case 2:
      playerContainer.removeClass("active");
      playerContainer.removeClass("paused");
      break;
  }
};

let playerHeight = $('.player').outerHeight();
let playerWidth = $('.player').outerWidth();



function onYouTubeIframeAPIReady() {
  player = new YT.Player("yt-player", {
    height: playerHeight,
    width: playerWidth,
    videoId: "8paoyY8BTO0",
    events: {
      onReady: onPlayerReady,
      onStateChange: onPlayerStateChange
    },
    playerVars: {
      controls: 0,
      disablekb: 0,
      showinfo: 0,
      rel: 0,
      autoplay: 0,
      modestbranding: 0
    }
  });
}

eventsInit();

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoibWFpbi5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbiAoKSB7XHJcbiAgLy8gV2UgbGlzdGVuIHRvIHRoZSByZXNpemUgZXZlbnRcclxuXHJcbiAgbGV0IHZoID0gd2luZG93LmlubmVySGVpZ2h0ICogMC4wMTtcclxuICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUuc2V0UHJvcGVydHkoJy0tdmgnLCBgJHt2aH1weGApO1xyXG4gIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCAoKSA9PiB7XHJcbiAgICAvLyBXZSBleGVjdXRlIHRoZSBzYW1lIHNjcmlwdCBhcyBiZWZvcmVcclxuICAgIGxldCB2aCA9IHdpbmRvdy5pbm5lckhlaWdodCAqIDAuMDE7XHJcbiAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUuc2V0UHJvcGVydHkoJy0tdmgnLCBgJHt2aH1weGApO1xyXG4gIH0pO1xyXG4gIGNvbnNvbGUubG9nKHZoKTtcclxuXHJcbiAgLy8gYm94IHNsaWRlclxyXG4gICQoJy5zbGlkZXJtZW51X19pdGVtcycpLmJ4U2xpZGVyKCk7XHJcblxyXG5cclxuICAvLyBmdWxsc2NyZWVuIG1lbnVcclxuXHJcbiAgY29uc3QgaGFtYnVyZ2VyTWVudSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuaGFtYnVyZ2VyLW1lbnUtbGlua1wiKTtcclxuICBjb25zdCBmdWxsU2NyZWVuTWVudSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuZnVsbHNjcmVlbi1tZW51XCIpO1xyXG4gIGNvbnN0IGZ1bGxTY3JlZW5NZW51Q2xvc2UgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLmZ1bGxzY3JlZW4tbWVudV9fY2xvc2VcIik7XHJcblxyXG4gIGhhbWJ1cmdlck1lbnUuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGZ1bmN0aW9uIChlKSB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICBmdWxsU2NyZWVuTWVudS5zdHlsZS5kaXNwbGF5ID0gXCJmbGV4XCI7XHJcbiAgfSk7XHJcblxyXG4gIGZ1bGxTY3JlZW5NZW51Q2xvc2UuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGZ1bmN0aW9uIChlKSB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICBmdWxsU2NyZWVuTWVudS5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XHJcbiAgfSk7XHJcblxyXG4gICQoXCIubWVudV9fbGlua1wiKS5vbignY2xpY2snLCBlID0+IHtcclxuICAgICQoZnVsbFNjcmVlbk1lbnUpLmNzcyh7ICdkaXNwbGF5JzogJ25vbmUnIH0pO1xyXG4gIH0pXHJcblxyXG5cclxuXHJcbiAgLy8gdGVhbSBzZWN0aW9uXHJcbiAgbGV0IHRlYW1JdGVtcyA9ICQoJy50ZWFtX19pdGVtJyk7XHJcbiAgbGV0IHRlYW1JdGVtTGluayA9ICQoJy50ZWFtX19saW5rJyk7XHJcblxyXG4gICQoJy50ZWFtX19saW5rJykub24oJ2NsaWNrJywgKGUpID0+IHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuXHJcbiAgICAkKGUuY3VycmVudFRhcmdldCkuY2xvc2VzdCgnLnRlYW1fX2l0ZW0nKS50b2dnbGVDbGFzcygndGVhbV9faXRlbS0tYWN0aXZlJyk7XHJcbiAgICAkKGUuY3VycmVudFRhcmdldCkuY2xvc2VzdCgnLnRlYW1fX2l0ZW0nKS5zaWJsaW5ncygnLnRlYW1fX2l0ZW0nKS5yZW1vdmVDbGFzcygndGVhbV9faXRlbS0tYWN0aXZlJyk7XHJcbiAgfSlcclxuXHJcbiAgLy9idXJnZXIgbWVudVxyXG5cclxuICAkKCcuYnVyZ2VybWVudV9fdHJpZ2dlcicpLm9uKCdjbGljaycsIGUgPT4ge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cclxuICAgICQoZS5jdXJyZW50VGFyZ2V0KS5jbG9zZXN0KCcuYnVyZ2VybWVudV9faXRlbScpLnRvZ2dsZUNsYXNzKCdidXJnZXJtZW51X19pdGVtLS1hY3RpdmUnKTtcclxuICAgICQoZS5jdXJyZW50VGFyZ2V0KS5jbG9zZXN0KCcuYnVyZ2VybWVudV9faXRlbScpLnNpYmxpbmdzKCcuYnVyZ2VybWVudV9faXRlbScpLnJlbW92ZUNsYXNzKCdidXJnZXJtZW51X19pdGVtLS1hY3RpdmUnKTtcclxuICB9KVxyXG5cclxuICAkKCcuYnVyZ2VybWVudV9fY2xvc2UnKS5vbignY2xpY2snLCBlID0+IHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuXHJcbiAgICAkKCcuYnVyZ2VybWVudV9fdHJpZ2dlcicpLmNsaWNrKCk7XHJcbiAgfSk7XHJcbiAgLy8gb3JkZXIgbWVudVxyXG5cclxuICBjb25zdCBvcmRlckZvcm0gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcub3JkZXJGb3JtJyk7XHJcbiAgY29uc3Qgb3JkZXJCdG4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjb3JkZXJfX2J0bicpO1xyXG5cclxuICBvcmRlckJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAvLyBjb25zb2xlLmxvZyhvcmRlckZvcm0uZWxlbWVudHMubmFtZS52YWx1ZSk7XHJcbiAgICBpZiAodmFsaWRhdGVGb3JtKG9yZGVyRm9ybSkpIHtcclxuICAgICAgLy8gY29uc29sZS5sb2coJ3ZzZXcgb2snKTtcclxuICAgICAgY29uc3QgZGF0YSA9IHtcclxuICAgICAgICBuYW1lOiBvcmRlckZvcm0uZWxlbWVudHMubmFtZS52YWx1ZSxcclxuICAgICAgICBwaG9uZTogb3JkZXJGb3JtLmVsZW1lbnRzLnBob25lLnZhbHVlLFxyXG4gICAgICAgIGNvbW1lbnQ6IG9yZGVyRm9ybS5lbGVtZW50cy5jb21tZW50LnZhbHVlLFxyXG4gICAgICAgIHRvOiAnc29tZS1tYWlsQG1haWwuY29tJyAvLyDQn9C+INC30LDQtNCw0L3QuNGOINGB0LXRgNCy0LXRgCDQv9GA0LjQvdC40LzQsNC10YIg0YfQtdGC0YvRgNC1INC/0LDRgNCw0LzQtdGC0YDQsCwg0LLQutC70Y7Rh9Cw0Y8gZW1haWwuIFxyXG4gICAgICAgIC8vINCd0L4g0L/QviDQvNCw0LrQtdGC0YMg0LIg0YTQvtGA0LzQtSBlbWFpbCDQvtC9INC+0YLRgdGD0YLRgdGC0LLRg9C10YIuXHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XHJcbiAgICAgIHhoci5yZXNwb25zZVR5cGUgPSAnanNvbic7XHJcbiAgICAgIHhoci5vcGVuKCdQT1NUJywgJ2h0dHBzOi8vd2ViZGV2LWFwaS5sb2Z0c2Nob29sLmNvbS9zZW5kbWFpbCcpO1xyXG4gICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignY29udGVudC10eXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcclxuICAgICAgeGhyLnNlbmQoSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xyXG4gICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsICgpID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyh4aHIucmVzcG9uc2UubWVzc2FnZSk7XHJcbiAgICAgICAgb3ZlcmxheU9yZGVyLm9wZW4oKTtcclxuICAgICAgICBvdmVybGF5T3JkZXIuc2V0Q29udGVudCh4aHIucmVzcG9uc2UubWVzc2FnZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICBmdW5jdGlvbiB2YWxpZGF0ZUZvcm0oZm9ybSkge1xyXG4gICAgbGV0IHZhbGlkID0gdHJ1ZTtcclxuXHJcbiAgICBpZiAoIXZhbGlkYXRlRmllbGQoZm9ybS5lbGVtZW50cy5uYW1lKSkge1xyXG4gICAgICB2YWxpZCA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghdmFsaWRhdGVGaWVsZChmb3JtLmVsZW1lbnRzLnBob25lKSkge1xyXG4gICAgICB2YWxpZCA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghdmFsaWRhdGVGaWVsZChmb3JtLmVsZW1lbnRzLmNvbW1lbnQpKSB7XHJcbiAgICAgIHZhbGlkID0gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHZhbGlkO1xyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gdmFsaWRhdGVGaWVsZChmaWVsZCkge1xyXG4gICAgLy8gZmllbGQubmV4dEVsZW1lbnRTaWJsaW5nLnRleHRDb250ZW50ID0gZmllbGQudmFsaWRhdGlvbk1lc3NhZ2U7XHJcbiAgICBpZiAoZmllbGQuY2hlY2tWYWxpZGl0eSgpKSB7XHJcbiAgICAgICQoZmllbGQpLmNzcygnYm9yZGVyLWNvbG9yJywgJ3RyYW5zcGFyZW50Jyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAkKGZpZWxkKS5jc3MoJ2JvcmRlci1jb2xvcicsICdyZWQnKTtcclxuICAgIH1cclxuICAgIHJldHVybiBmaWVsZC5jaGVja1ZhbGlkaXR5KCk7XHJcbiAgfVxyXG5cclxuXHJcbiAgLy9vdmVybGF5XHJcblxyXG4gIC8vIGNvbnN0IG9wZW5PdmVybGF5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI29wZW5PdmVybGF5Jyk7XHJcbiAgY29uc3QgdGFtcGxhdGVPcmRlciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNvdmVybGF5T3JkZXInKS5pbm5lckhUTUw7XHJcbiAgY29uc3Qgb3ZlcmxheU9yZGVyID0gY3JlYXRlT3ZlcmxheSh0YW1wbGF0ZU9yZGVyLCAndGFtcGxhdGVPcmRlcicpO1xyXG5cclxuICAvLyBvcGVuT3ZlcmxheS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGUgPT4ge1xyXG4gIC8vICAgb3ZlcmxheS5vcGVuKCk7XHJcbiAgLy8gICBvdmVybGF5LnNldENvbnRlbnQoJ1ZzZSBvaycpO1xyXG4gIC8vIH0pO1xyXG5cclxuICBmdW5jdGlvbiBjcmVhdGVPdmVybGF5KHRhbXBsYXRlLCBjbGFzc1RhbXBsYXRlKSB7XHJcbiAgICBjb25zdCBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgZnJhZ21lbnQuaW5uZXJIVE1MID0gdGFtcGxhdGU7XHJcblxyXG4gICAgY29uc3Qgb3ZlcmxheUVsZW1lbnQgPSBmcmFnbWVudC5xdWVyeVNlbGVjdG9yKCcub3ZlcmxheScpO1xyXG4gICAgY29uc3QgY29udGFpbmVyRWxlbWVudCA9IGZyYWdtZW50LnF1ZXJ5U2VsZWN0b3IoJy5vdmVybGF5X19jb250YWluZXInKTtcclxuICAgIGNvbnRhaW5lckVsZW1lbnQuY2xhc3NMaXN0LmFkZChjbGFzc1RhbXBsYXRlKTtcclxuICAgIGNvbnN0IGNsb3NlRWxlbWVudCA9IGZyYWdtZW50LnF1ZXJ5U2VsZWN0b3IoJy5vdmVybGF5X19jbG9zZScpO1xyXG4gICAgY29uc3QgY29udGVudEVsZW1lbnQgPSBmcmFnbWVudC5xdWVyeVNlbGVjdG9yKCcub3ZlcmxheV9fY29udGVudCcpO1xyXG5cclxuICAgIG92ZXJsYXlFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZSA9PiB7XHJcbiAgICAgIGlmIChlLnRhcmdldCA9PT0gb3ZlcmxheUVsZW1lbnQpIHtcclxuICAgICAgICBjbG9zZUVsZW1lbnQuY2xpY2soKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgY2xvc2VFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHtcclxuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKG92ZXJsYXlFbGVtZW50KTtcclxuICAgIH0pXHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgb3BlbigpIHtcclxuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG92ZXJsYXlFbGVtZW50KTtcclxuICAgICAgfSxcclxuICAgICAgY2xvc2UoKSB7XHJcbiAgICAgICAgY2xvc2VFbGVtZW50LmNsaWNrKCk7XHJcbiAgICAgIH0sXHJcbiAgICAgIHNldENvbnRlbnQoY29udGVudCkge1xyXG4gICAgICAgIGNvbnRlbnRFbGVtZW50LmlubmVySFRNTCA9IGNvbnRlbnQ7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgfVxyXG5cclxuICAvLyByZXZpZXdzIFxyXG4gIGNvbnN0IHRhbXBsYXRlUmV2aWV3ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI292ZXJsYXlSZXZpZXcnKS5pbm5lckhUTUw7XHJcbiAgY29uc3Qgb3ZlcmxheVJldmlldyA9IGNyZWF0ZU92ZXJsYXkodGFtcGxhdGVSZXZpZXcpO1xyXG5cclxuICBjb25zdCByZXZpZXdPdmVybGF5QnRuID0gJCgnLnJldmlld19fYnRuJyk7XHJcblxyXG4gIHJldmlld092ZXJsYXlCdG4ub24oJ2NsaWNrJywgZSA9PiB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICBsZXQgcmV2aWV3Q29udGVudCA9ICQoZS5jdXJyZW50VGFyZ2V0KS5zaWJsaW5ncygnLnJldmlld19fY29udGVudCcpLnByb3AoJ291dGVySFRNTCcpO1xyXG5cclxuICAgIG92ZXJsYXlSZXZpZXcub3BlbigpO1xyXG4gICAgb3ZlcmxheVJldmlldy5zZXRDb250ZW50KHJldmlld0NvbnRlbnQpO1xyXG4gIH0pXHJcblxyXG4gIC8vb25lIHBhZ2Ugc2Nyb2xsXHJcbiAgY29uc3Qgc2VjdGlvbnMgPSAkKCcuc2VjdGlvbicpO1xyXG4gIGNvbnN0IGRpc3BsYXkgPSAkKCcubWFpbmNvbnRlbnQnKTtcclxuXHJcbiAgbGV0IGluU2Nyb2xsID0gZmFsc2U7IC8vINC10YHRgtGMINC70Lgg0L/QtdGA0LXQvNC10YnQtdC90LjQtVxyXG5cclxuXHJcbiAgY29uc3QgY291bnRTZWN0aW9uUG9zaXRpb24gPSAoc2VjdGlvbkluZGV4KSA9PiB7XHJcbiAgICBjb25zdCBwb3NpdGlvbiA9IHNlY3Rpb25JbmRleCAqICgtMTAwKTtcclxuICAgIC8vIGNvbnNvbGUubG9nKHBvc2l0aW9uKTtcclxuICAgIGlmIChpc05hTihwb3NpdGlvbikpIHtcclxuICAgICAgY29uc29sZS5lcnJvcihcItC/0LXRgNC10LTQsNC90L4g0L3QtSDQstC10YDQvdC+0LUg0LfQvdCw0YfQtdC90LjQtSDQsiBjb3VudFNlY3Rpb25Qb3NpdG9uXCIpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHBvc2l0aW9uO1xyXG5cclxuICB9XHJcblxyXG4gIGNvbnN0IHJlc2V0QWN0aXZlQ2xhc3MgPSBmdW5jdGlvbiAoc2VjdGlvbiwgc2VjdGlvbkluZGV4KSB7XHJcbiAgICBzZWN0aW9uLmVxKHNlY3Rpb25JbmRleCkuYWRkQ2xhc3MoJ2FjdGl2ZScpLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpO1xyXG4gICAgJCgnLmZpeGVkLW1lbnVfX2l0ZW0nKS5lcShzZWN0aW9uSW5kZXgpLmFkZENsYXNzKCdhY3RpdmUnKS5zaWJsaW5ncygpLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTtcclxuICB9O1xyXG5cclxuICBjb25zdCBwZXJmb3JtVHJhbnNpdGlvbiA9IChzZWN0aW9uSW5kZXgpID0+IHtcclxuICAgIGlmIChpblNjcm9sbCkgcmV0dXJuOyAvLyDQv9GA0L7QstC10YDRj9C10LwgLCDQtdGB0YLRjCDQu9C4INC/0LXRgNC10LzQtdGJ0LXQvdC40LUg0YHQtdC50YfQsNGBXHJcbiAgICBpblNjcm9sbCA9IHRydWU7IC8v0YDQsNC30YDQtdGI0LDQtdC8INC/0LXRgNC10LzQtdGJ0LXQvdC40LVcclxuICAgIC8v0L7Qv9GA0LXQtNC10LvRj9C10Lwg0L/QvtC30LjRhtC40Y4g0YHQtdC60YbQuNC4INC4INGA0LDRgdGH0LjRgtGL0LLQsNC10Lwg0LfQvdCw0YfQtdC90LjQtSDQv9C10YDQtdC80LXRidC10L3QuNGPXHJcbiAgICBjb25zdCBwb3NpdGlvbiA9IGNvdW50U2VjdGlvblBvc2l0aW9uKHNlY3Rpb25JbmRleCk7XHJcbiAgICBjb25zdCB0cmFzaXRpb25PdmVyID0gNTAwOyAvLyDQstGA0LXQvNGPINC30LDQtNC10YDQttC60LhcclxuXHJcbiAgICAvL9C80LXQvdGP0LXQvCDQsNC60YLQuNCy0L3Ri9C5INC60LvQsNGB0YFcclxuICAgIHJlc2V0QWN0aXZlQ2xhc3Moc2VjdGlvbnMsIHNlY3Rpb25JbmRleCk7XHJcblxyXG4gICAgLy/Qv9C10YDQtdC80LXRidGP0LXQvCBtYWluY29udGVudCDQvdCwINGD0LrQsNC30LDQvdC90YPRjiDQv9C+0LfQuNGG0LjRjlxyXG4gICAgZGlzcGxheS5jc3Moe1xyXG4gICAgICB0cmFuc2Zvcm06IGB0cmFuc2xhdGVZKCR7cG9zaXRpb259JSlgLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy/Rg9GB0YLQsNC90LDQstC70LjQstCw0LXQvCDQstGA0LXQvNGPINC30LDQtNC10YDQttC60LhcclxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICBpblNjcm9sbCA9IGZhbHNlOyAvL9C30LDQv9GA0LXRidGP0LXQvCDQv9C10YDQtdC80LXRidC10L3QuNC1XHJcbiAgICAgIC8vIHJlc2V0QWN0aXZlQ2xhc3MoJChcIi5maXhlZC1tZW51X19pdGVtXCIpLCBzZWN0aW9uRXEpO1xyXG4gICAgfSwgdHJhc2l0aW9uT3Zlcik7XHJcblxyXG4gIH1cclxuXHJcbiAgY29uc3QgcGFnZVNjcm9sbCA9IGZ1bmN0aW9uICgpIHtcclxuICAgIGNvbnN0IGFjdGl2ZVNlY3Rpb24gPSBzZWN0aW9ucy5maWx0ZXIoJy5hY3RpdmUnKTtcclxuICAgIGNvbnN0IG5leHRTZWN0aW9uID0gYWN0aXZlU2VjdGlvbi5uZXh0KCk7XHJcbiAgICBjb25zdCBwcmV2U2VjdGlvbiA9IGFjdGl2ZVNlY3Rpb24ucHJldigpO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIG5leHQoKSB7XHJcbiAgICAgICAgLy8g0LXRgdGC0Ywg0LvQuCDRgdC10LrRhtC40Y8g0YHQvdC40LfRg1xyXG4gICAgICAgIGlmIChuZXh0U2VjdGlvbi5sZW5ndGgpIHtcclxuICAgICAgICAgIHBlcmZvcm1UcmFuc2l0aW9uKG5leHRTZWN0aW9uLmluZGV4KCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuICAgICAgcHJldigpIHtcclxuICAgICAgICAvLyDQtdGB0YLRjCDQu9C4INGB0LXQutGG0LjRjyDRgdCy0LXRgNGF0YNcclxuICAgICAgICBpZiAocHJldlNlY3Rpb24ubGVuZ3RoKSB7XHJcbiAgICAgICAgICBwZXJmb3JtVHJhbnNpdGlvbihwcmV2U2VjdGlvbi5pbmRleCgpKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgfTtcclxuXHJcbiAgLy/QvtCx0YDQsNCx0L7RgtC60LAg0YHQvtCx0YvRgtC40Lk6IFxyXG5cclxuICAkKGRvY3VtZW50KS5rZXlkb3duKGUgPT4ge1xyXG4gICAgY29uc3QgdGFyZ2V0TmFtZSA9IGUudGFyZ2V0LnRhZ05hbWUudG9Mb3dlckNhc2UoKTtcclxuICAgIGNvbnN0IHdpbmRvd1Njcm9sbGVyID0gcGFnZVNjcm9sbCgpO1xyXG5cclxuICAgIGlmICh0YXJnZXROYW1lID09PSAnYm9keScpIHtcclxuXHJcbiAgICAgIGlmIChlLmtleSA9PT0gXCJBcnJvd0Rvd25cIikge1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCdhcnJvdyBkb3duJyk7XHJcbiAgICAgICAgd2luZG93U2Nyb2xsZXIubmV4dCgpO1xyXG4gICAgICB9IGVsc2UgaWYgKGUua2V5ID09PSBcIkFycm93VXBcIikge1xyXG4gICAgICAgIHdpbmRvd1Njcm9sbGVyLnByZXYoKTtcclxuICAgICAgICAvLyBjb25zb2xlLmxvZygnYXJyb3cgdXAnKTtcclxuICAgICAgfSBlbHNlIGlmIChlLmtleUNvZGUgPT09IDMyKSB7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJzcGFjZVwiKTtcclxuICAgICAgICB3aW5kb3dTY3JvbGxlci5uZXh0KCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgJCgnW3Njcm9sbC10b10nKS5vbignY2xpY2snLCAoZSkgPT4ge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgLy8gY29uc29sZS5sb2coZS5jdXJyZW50VGFyZ2V0KTtcclxuICAgIGxldCBtZW51SW5kZXggPSAkKGUuY3VycmVudFRhcmdldCkuYXR0cignc2Nyb2xsLXRvJyk7XHJcbiAgICBwZXJmb3JtVHJhbnNpdGlvbihtZW51SW5kZXgpO1xyXG4gIH0pO1xyXG5cclxuICAkKHdpbmRvdykub24oXCJ3aGVlbFwiLCAoZSkgPT4ge1xyXG4gICAgY29uc3QgZGVsdGFZID0gZS5vcmlnaW5hbEV2ZW50LmRlbHRhWTtcclxuICAgIGNvbnN0IHdpbmRvd1Njcm9sbGVyID0gcGFnZVNjcm9sbCgpO1xyXG5cclxuICAgIGlmIChkZWx0YVkgPiAwKSB7XHJcbiAgICAgIHdpbmRvd1Njcm9sbGVyLm5leHQoKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZGVsdGFZIDwgMCkge1xyXG4gICAgICB3aW5kb3dTY3JvbGxlci5wcmV2KCk7XHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gICQoJy5zY3JvbGwtZG93bicpLm9uKCdjbGljaycsIGUgPT4ge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgcGVyZm9ybVRyYW5zaXRpb24oMSk7XHJcbiAgfSk7XHJcblxyXG5cclxuXHJcbiAgLy8vIGh0dHA6Ly9oZ29lYmwuZ2l0aHViLmlvL21vYmlsZS1kZXRlY3QuanMvXHJcbiAgY29uc3QgbWQgPSBuZXcgTW9iaWxlRGV0ZWN0KHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50KTtcclxuICBjb25zdCBpc01vYmlsZSA9IG1kLm1vYmlsZSgpO1xyXG4gIC8vIGNvbnNvbGUubG9nKGlzTW9iaWxlKTtcclxuXHJcbiAgaWYgKGlzTW9iaWxlKSB7XHJcbiAgICAvLyBodHRwOi8vZ2l0aHViLmNvbS9tYXR0YnJ5c29uL1RvdWNoU3dpcGUtSnF1ZXJ5LVBsdWdpblxyXG4gICAgJChcImJvZHlcIikuc3dpcGUoe1xyXG4gICAgICAvL0dlbmVyaWMgc3dpcGUgaGFuZGxlciBmb3IgYWxsIGRpcmVjdGlvbnNcclxuICAgICAgc3dpcGU6IGZ1bmN0aW9uIChldmVudCwgZGlyZWN0aW9uLCBkaXN0YW5jZSwgZHVyYXRpb24sIGZpbmdlckNvdW50LCBmaW5nZXJEYXRhKSB7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJZb3Ugc3dpcGVkIFwiICsgZGlyZWN0aW9uICk7XHJcbiAgICAgICAgY29uc3Qgd2luZG93U2Nyb2xsZXIgPSBwYWdlU2Nyb2xsKCk7XHJcblxyXG4gICAgICAgIGlmIChkaXJlY3Rpb24gPT09ICd1cCcpIHtcclxuICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCd1cCcpO1xyXG4gICAgICAgICAgd2luZG93U2Nyb2xsZXIubmV4dCgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGRpcmVjdGlvbiA9PT0gJ2Rvd24nKSB7XHJcbiAgICAgICAgICAvLyBjb25zb2xlLmxvZygnZG93bicpO1xyXG4gICAgICAgICAgd2luZG93U2Nyb2xsZXIucHJldigpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8vXHJcblxyXG4gIC8vXHJcblxyXG4gIC8vIHlhbmRleCBtYXBcclxuICBsZXQgbXlNYXA7XHJcbiAgY29uc3QgaW5pdCA9ICgpID0+IHtcclxuICAgIG15TWFwID0gbmV3IHltYXBzLk1hcChcIm1hcFwiLCB7XHJcbiAgICAgIGNlbnRlcjogWzU5LjkzODk1MSwgMzAuMzE1NjM1XSxcclxuICAgICAgem9vbTogMTEsXHJcbiAgICAgIGNvbnRyb2xzOiBbXVxyXG4gICAgfSk7XHJcbiAgICBjb25zdCBjb29yZHMgPSBbXHJcbiAgICAgIFs1OS44ODg4MzQsIDMwLjMyMTc5M10sXHJcbiAgICAgIFs1OS45MzY2MjAsIDMwLjI1OTQ1NF0sXHJcbiAgICAgIFs1OS45MzE0NTQsIDMwLjM0NTc2NF0sXHJcbiAgICAgIFs1OS44NjEzODEsIDMwLjM5ODg0NV0sXHJcbiAgICBdO1xyXG4gICAgY29uc3QgbXlDb2xsZWN0aW9uID0gbmV3IHltYXBzLkdlb09iamVjdENvbGxlY3Rpb24oe30sIHtcclxuICAgICAgZHJhZ2dhYmxlOiBmYWxzZSxcclxuICAgICAgaWNvbkxheW91dDogJ2RlZmF1bHQjaW1hZ2UnLFxyXG4gICAgICBpY29uSW1hZ2VIcmVmOiAnLi9pbWcvaWNvbnMvbWFwLW1hcmtlci5zdmcnLFxyXG4gICAgICBpY29uSW1hZ2VTaXplOiBbNDYsIDU3XSxcclxuICAgICAgaWNvbkltYWdlT2Zmc2V0OiBbLTM1LCAtNTJdXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb29yZHMuZm9yRWFjaChjb29yZCA9PiB7XHJcbiAgICAgIG15Q29sbGVjdGlvbi5hZGQobmV3IHltYXBzLlBsYWNlbWFyayhjb29yZCkpO1xyXG4gICAgfSlcclxuXHJcbiAgICBteU1hcC5nZW9PYmplY3RzLmFkZChteUNvbGxlY3Rpb24pO1xyXG4gICAgbXlNYXAuYmVoYXZpb3JzLmRpc2FibGUoJ3Njcm9sbFpvb20nKTtcclxuICB9O1xyXG5cclxuXHJcbiAgeW1hcHMucmVhZHkoaW5pdCk7XHJcblxyXG5cclxufSk7IC8vZG9jdW1lbnQgcmVhZHlcclxuXHJcblxyXG4vLy8geW91dHViZSBwbGF5ZXJcclxuXHJcbmxldCBwbGF5ZXI7XHJcbmNvbnN0IHBsYXllckNvbnRhaW5lciA9ICQoXCIucGxheWVyXCIpO1xyXG5cclxubGV0IGV2ZW50c0luaXQgPSAoKSA9PiB7XHJcbiAgJChcIi5wbGF5ZXJfX3N0YXJ0XCIpLmNsaWNrKGUgPT4ge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cclxuICAgIGlmIChwbGF5ZXJDb250YWluZXIuaGFzQ2xhc3MoXCJwYXVzZWRcIikpIHtcclxuICAgICAgcGxheWVyLnBhdXNlVmlkZW8oKTtcclxuICAgICAgY29uc29sZS5sb2cocGxheWVyKTtcclxuXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBwbGF5ZXIucGxheVZpZGVvKCk7XHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gICQoXCIucGxheWVyX19wbGF5YmFja1wiKS5jbGljayhlID0+IHtcclxuICAgIGNvbnN0IGJhciA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcclxuICAgIGNvbnN0IGNsaWNrZWRQb3NpdGlvbiA9IGUub3JpZ2luYWxFdmVudC5sYXllclg7XHJcbiAgICBjb25zdCBuZXdCdXR0b25Qb3NpdGlvblBlcmNlbnQgPSAoY2xpY2tlZFBvc2l0aW9uIC8gYmFyLndpZHRoKCkpICogMTAwO1xyXG4gICAgY29uc3QgbmV3UGxheWJhY2tQb3NpdGlvblNlYyA9XHJcbiAgICAgIChwbGF5ZXIuZ2V0RHVyYXRpb24oKSAvIDEwMCkgKiBuZXdCdXR0b25Qb3NpdGlvblBlcmNlbnQ7XHJcblxyXG4gICAgJChcIi5wbGF5ZXJfX3BsYXliYWNrLWJ1dHRvblwiKS5jc3Moe1xyXG4gICAgICBsZWZ0OiBgJHtuZXdCdXR0b25Qb3NpdGlvblBlcmNlbnR9JWBcclxuICAgIH0pO1xyXG5cclxuICAgIHBsYXllci5zZWVrVG8obmV3UGxheWJhY2tQb3NpdGlvblNlYyk7XHJcbiAgfSk7XHJcblxyXG4gICQoXCIucGxheWVyX19zcGxhc2hcIikuY2xpY2soZSA9PiB7XHJcbiAgICBwbGF5ZXIucGxheVZpZGVvKCk7XHJcbiAgfSlcclxuXHJcbiAgJChcIi5wbGF5ZXJfX3ZvbHVtZS1idXR0b25cIikuY2xpY2soZSA9PiB7XHJcbiAgICBpZiAocGxheWVyLmlzTXV0ZWQoKSkge1xyXG4gICAgICBwbGF5ZXIudW5NdXRlKCk7XHJcbiAgICAgICQoZS5jdXJyZW50VGFyZ2V0KS5wYXJlbnQoKS5yZW1vdmVDbGFzcyhcIm11dGVcIik7XHJcbiAgICAgICQoJy5wbGF5ZXJfX3ZvbHVtZS1sZXZlbC1idXR0b24nKS5jc3Moe1xyXG4gICAgICAgIGxlZnQ6IGAkeyhwbGF5ZXIuZ2V0Vm9sdW1lKCkpfSVgXHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcGxheWVyLm11dGUoKTtcclxuICAgICAgJChlLmN1cnJlbnRUYXJnZXQpLnBhcmVudCgpLmFkZENsYXNzKFwibXV0ZVwiKTtcclxuICAgICAgJCgnLnBsYXllcl9fdm9sdW1lLWxldmVsLWJ1dHRvbicpLmNzcyh7XHJcbiAgICAgICAgbGVmdDogMFxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgJCgnLnBsYXllcl9fdm9sdW1lLWxldmVsJykuY2xpY2soZSA9PiB7XHJcbiAgICBjb25zdCB2b2x1bWVMZXZlbCA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcclxuICAgIGNvbnN0IHZvbHVtZUxldmVsQ2xpY2tQb3NpdGlvbiA9IGUub3JpZ2luYWxFdmVudC5sYXllclg7XHJcbiAgICBjb25zdCBuZXdWb2x1bWVMZXZlbCA9ICh2b2x1bWVMZXZlbENsaWNrUG9zaXRpb24gLyB2b2x1bWVMZXZlbC53aWR0aCgpKSAqIDEwMDtcclxuICAgIHBsYXllci5zZXRWb2x1bWUobmV3Vm9sdW1lTGV2ZWwpO1xyXG5cclxuICAgIGlmIChuZXdWb2x1bWVMZXZlbCA9PT0gMCkge1xyXG4gICAgICBwbGF5ZXIubXV0ZSgpO1xyXG4gICAgICAkKFwiLnBsYXllcl9fdm9sdW1lXCIpLmFkZENsYXNzKFwibXV0ZVwiKTtcclxuICAgICAgJCgnLnBsYXllcl9fdm9sdW1lLWxldmVsLWJ1dHRvbicpLmNzcyh7XHJcbiAgICAgICAgbGVmdDogMFxyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHBsYXllci51bk11dGUoKTtcclxuICAgICAgJChcIi5wbGF5ZXJfX3ZvbHVtZVwiKS5yZW1vdmVDbGFzcyhcIm11dGVcIik7XHJcbiAgICAgICQoJy5wbGF5ZXJfX3ZvbHVtZS1sZXZlbC1idXR0b24nKS5jc3Moe1xyXG4gICAgICAgIGxlZnQ6IGAke25ld1ZvbHVtZUxldmVsfSVgXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgLy8gY29uc3QgbmV3Vm9sdW1lTGV2ZWwgPSAocGxheWVyLmdldFZvbHVtZSgpKVxyXG5cclxuXHJcbiAgfSk7XHJcbn07XHJcblxyXG5jb25zdCBmb3JtYXRUaW1lID0gdGltZVNlYyA9PiB7XHJcbiAgY29uc3Qgcm91bmRUaW1lID0gTWF0aC5yb3VuZCh0aW1lU2VjKTtcclxuXHJcbiAgY29uc3QgbWludXRlcyA9IGFkZFplcm8oTWF0aC5mbG9vcihyb3VuZFRpbWUgLyA2MCkpO1xyXG4gIGNvbnN0IHNlY29uZHMgPSBhZGRaZXJvKHJvdW5kVGltZSAtIG1pbnV0ZXMgKiA2MCk7XHJcblxyXG4gIGZ1bmN0aW9uIGFkZFplcm8obnVtKSB7XHJcbiAgICByZXR1cm4gbnVtIDwgMTAgPyBgMCR7bnVtfWAgOiBudW07XHJcbiAgfVxyXG5cclxuICByZXR1cm4gYCR7bWludXRlc30gOiAke3NlY29uZHN9YDtcclxufTtcclxuXHJcbmNvbnN0IG9uUGxheWVyUmVhZHkgPSAoKSA9PiB7XHJcbiAgbGV0IGludGVydmFsO1xyXG4gIGNvbnN0IGR1cmF0aW9uU2VjID0gcGxheWVyLmdldER1cmF0aW9uKCk7XHJcblxyXG4gICQoXCIucGxheWVyX19kdXJhdGlvbi1lc3RpbWF0ZVwiKS50ZXh0KGZvcm1hdFRpbWUoZHVyYXRpb25TZWMpKTtcclxuXHJcbiAgaWYgKHR5cGVvZiBpbnRlcnZhbCAhPT0gXCJ1bmRlZmluZWRcIikge1xyXG4gICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XHJcbiAgfVxyXG5cclxuICBpbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHtcclxuICAgIGNvbnN0IGNvbXBsZXRlZFNlYyA9IHBsYXllci5nZXRDdXJyZW50VGltZSgpO1xyXG4gICAgY29uc3QgY29tcGxldGVkUGVyY2VudCA9IChjb21wbGV0ZWRTZWMgLyBkdXJhdGlvblNlYykgKiAxMDA7XHJcblxyXG4gICAgJChcIi5wbGF5ZXJfX3BsYXliYWNrLWJ1dHRvblwiKS5jc3Moe1xyXG4gICAgICBsZWZ0OiBgJHtjb21wbGV0ZWRQZXJjZW50fSVgXHJcbiAgICB9KTtcclxuXHJcbiAgICAkKFwiLnBsYXllcl9fZHVyYXRpb24tY29tcGxldGVkXCIpLnRleHQoZm9ybWF0VGltZShjb21wbGV0ZWRTZWMpKTtcclxuICB9LCAxMDAwKTtcclxufTtcclxuXHJcbmNvbnN0IG9uUGxheWVyU3RhdGVDaGFuZ2UgPSBldmVudCA9PiB7XHJcbiAgLypcclxuICAgIC0xICjQstC+0YHQv9GA0L7QuNC30LLQtdC00LXQvdC40LUg0LLQuNC00LXQviDQvdC1INC90LDRh9Cw0YLQvilcclxuICAgIDAgKNCy0L7RgdC/0YDQvtC40LfQstC10LTQtdC90LjQtSDQstC40LTQtdC+INC30LDQstC10YDRiNC10L3QvilcclxuICAgIDEgKNCy0L7RgdC/0YDQvtC40LfQstC10LTQtdC90LjQtSlcclxuICAgIDIgKNC/0LDRg9C30LApXHJcbiAgICAzICjQsdGD0YTQtdGA0LjQt9Cw0YbQuNGPKVxyXG4gICAgNSAo0LLQuNC00LXQviDQv9C+0LTQsNGO0YIg0YDQtdC/0LvQuNC60LgpLlxyXG4gICovXHJcbiAgc3dpdGNoIChldmVudC5kYXRhKSB7XHJcbiAgICBjYXNlIDE6XHJcbiAgICAgIHBsYXllckNvbnRhaW5lci5hZGRDbGFzcyhcImFjdGl2ZVwiKTtcclxuICAgICAgcGxheWVyQ29udGFpbmVyLmFkZENsYXNzKFwicGF1c2VkXCIpO1xyXG4gICAgICBicmVhaztcclxuXHJcbiAgICBjYXNlIDI6XHJcbiAgICAgIHBsYXllckNvbnRhaW5lci5yZW1vdmVDbGFzcyhcImFjdGl2ZVwiKTtcclxuICAgICAgcGxheWVyQ29udGFpbmVyLnJlbW92ZUNsYXNzKFwicGF1c2VkXCIpO1xyXG4gICAgICBicmVhaztcclxuICB9XHJcbn07XHJcblxyXG5sZXQgcGxheWVySGVpZ2h0ID0gJCgnLnBsYXllcicpLm91dGVySGVpZ2h0KCk7XHJcbmxldCBwbGF5ZXJXaWR0aCA9ICQoJy5wbGF5ZXInKS5vdXRlcldpZHRoKCk7XHJcblxyXG5cclxuXHJcbmZ1bmN0aW9uIG9uWW91VHViZUlmcmFtZUFQSVJlYWR5KCkge1xyXG4gIHBsYXllciA9IG5ldyBZVC5QbGF5ZXIoXCJ5dC1wbGF5ZXJcIiwge1xyXG4gICAgaGVpZ2h0OiBwbGF5ZXJIZWlnaHQsXHJcbiAgICB3aWR0aDogcGxheWVyV2lkdGgsXHJcbiAgICB2aWRlb0lkOiBcIjhwYW95WThCVE8wXCIsXHJcbiAgICBldmVudHM6IHtcclxuICAgICAgb25SZWFkeTogb25QbGF5ZXJSZWFkeSxcclxuICAgICAgb25TdGF0ZUNoYW5nZTogb25QbGF5ZXJTdGF0ZUNoYW5nZVxyXG4gICAgfSxcclxuICAgIHBsYXllclZhcnM6IHtcclxuICAgICAgY29udHJvbHM6IDAsXHJcbiAgICAgIGRpc2FibGVrYjogMCxcclxuICAgICAgc2hvd2luZm86IDAsXHJcbiAgICAgIHJlbDogMCxcclxuICAgICAgYXV0b3BsYXk6IDAsXHJcbiAgICAgIG1vZGVzdGJyYW5kaW5nOiAwXHJcbiAgICB9XHJcbiAgfSk7XHJcbn1cclxuXHJcbmV2ZW50c0luaXQoKTtcclxuIl19
