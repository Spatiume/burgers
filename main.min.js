$(document).ready(function () {
  // We listen to the resize event

  let vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
  window.addEventListener('resize', () => {
    // We execute the same script as before
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
  });
  console.log(vh);

  // box slider
  $('.slidermenu__items').bxSlider();


  // fullscreen menu

  const hamburgerMenu = document.querySelector(".hamburger-menu-link");
  const fullScreenMenu = document.querySelector(".fullscreen-menu");
  const fullScreenMenuClose = document.querySelector(".fullscreen-menu__close");

  hamburgerMenu.addEventListener("click", function (e) {
    e.preventDefault();
    fullScreenMenu.style.display = "flex";
  });

  fullScreenMenuClose.addEventListener("click", function (e) {
    e.preventDefault();
    fullScreenMenu.style.display = "none";
  });

  $(".menu__link").on('click', e => {
    $(fullScreenMenu).css({ 'display': 'none' });
  })



  // team section
  let teamItems = $('.team__item');
  let teamItemLink = $('.team__link');

  $('.team__link').on('click', (e) => {
    e.preventDefault();

    $(e.currentTarget).closest('.team__item').toggleClass('team__item--active');
    $(e.currentTarget).closest('.team__item').siblings('.team__item').removeClass('team__item--active');
  })

  //burger menu

  $('.burgermenu__trigger').on('click', e => {
    e.preventDefault();

    $(e.currentTarget).closest('.burgermenu__item').toggleClass('burgermenu__item--active');
    $(e.currentTarget).closest('.burgermenu__item').siblings('.burgermenu__item').removeClass('burgermenu__item--active');
  })

  $('.burgermenu__close').on('click', e => {
    e.preventDefault();

    $('.burgermenu__trigger').click();
  });
  // order menu

  const orderForm = document.querySelector('.orderForm');
  const orderBtn = document.querySelector('#order__btn');

  orderBtn.addEventListener('click', (e) => {
    e.preventDefault();
    // console.log(orderForm.elements.name.value);
    if (validateForm(orderForm)) {
      // console.log('vsew ok');
      const data = {
        name: orderForm.elements.name.value,
        phone: orderForm.elements.phone.value,
        comment: orderForm.elements.comment.value,
        to: 'some-mail@mail.com' // По заданию сервер принимает четыре параметра, включая email. 
        // Но по макету в форме email он отсутствует.
      }
      const xhr = new XMLHttpRequest();
      xhr.responseType = 'json';
      xhr.open('POST', 'https://webdev-api.loftschool.com/sendmail');
      xhr.setRequestHeader('content-type', 'application/json');
      xhr.send(JSON.stringify(data));
      xhr.addEventListener('load', () => {
        console.log(xhr.response.message);
        overlayOrder.open();
        overlayOrder.setContent(xhr.response.message);
      });
    }
  });

  function validateForm(form) {
    let valid = true;

    if (!validateField(form.elements.name)) {
      valid = false;
    }

    if (!validateField(form.elements.phone)) {
      valid = false;
    }

    if (!validateField(form.elements.comment)) {
      valid = false;
    }

    return valid;
  }

  function validateField(field) {
    // field.nextElementSibling.textContent = field.validationMessage;
    if (field.checkValidity()) {
      $(field).css('border-color', 'transparent');
    } else {
      $(field).css('border-color', 'red');
    }
    return field.checkValidity();
  }


  //overlay

  // const openOverlay = document.querySelector('#openOverlay');
  const tamplateOrder = document.querySelector('#overlayOrder').innerHTML;
  const overlayOrder = createOverlay(tamplateOrder, 'tamplateOrder');

  // openOverlay.addEventListener('click', e => {
  //   overlay.open();
  //   overlay.setContent('Vse ok');
  // });

  function createOverlay(tamplate, classTamplate) {
    const fragment = document.createElement('div');
    fragment.innerHTML = tamplate;

    const overlayElement = fragment.querySelector('.overlay');
    const containerElement = fragment.querySelector('.overlay__container');
    containerElement.classList.add(classTamplate);
    const closeElement = fragment.querySelector('.overlay__close');
    const contentElement = fragment.querySelector('.overlay__content');

    overlayElement.addEventListener('click', e => {
      if (e.target === overlayElement) {
        closeElement.click();
      }
    });

    closeElement.addEventListener('click', (e) => {
      e.preventDefault();
      document.body.removeChild(overlayElement);
    })

    return {
      open() {
        document.body.appendChild(overlayElement);
      },
      close() {
        closeElement.click();
      },
      setContent(content) {
        contentElement.innerHTML = content;
      }
    }

  }

  // reviews 
  const tamplateReview = document.querySelector('#overlayReview').innerHTML;
  const overlayReview = createOverlay(tamplateReview);

  const reviewOverlayBtn = $('.review__btn');

  reviewOverlayBtn.on('click', e => {
    e.preventDefault();
    let reviewContent = $(e.currentTarget).siblings('.review__content').prop('outerHTML');

    overlayReview.open();
    overlayReview.setContent(reviewContent);
  })

  //one page scroll
  const sections = $('.section');
  const display = $('.maincontent');

  let inScroll = false; // есть ли перемещение


  const countSectionPosition = (sectionIndex) => {
    const position = sectionIndex * (-100);
    // console.log(position);
    if (isNaN(position)) {
      console.error("передано не верное значение в countSectionPositon");
    }
    return position;

  }

  const resetActiveClass = function (section, sectionIndex) {
    section.eq(sectionIndex).addClass('active').siblings().removeClass('active');
    $('.fixed-menu__item').eq(sectionIndex).addClass('active').siblings().removeClass('active');
  };

  const performTransition = (sectionIndex) => {
    if (inScroll) return; // проверяем , есть ли перемещение сейчас
    inScroll = true; //разрешаем перемещение
    //определяем позицию секции и расчитываем значение перемещения
    const position = countSectionPosition(sectionIndex);
    const trasitionOver = 500; // время задержки

    //меняем активный класс
    resetActiveClass(sections, sectionIndex);

    //перемещяем maincontent на указанную позицию
    display.css({
      transform: `translateY(${position}%)`,
    });

    //устанавливаем время задержки
    setTimeout(() => {
      inScroll = false; //запрещяем перемещение
      // resetActiveClass($(".fixed-menu__item"), sectionEq);
    }, trasitionOver);

  }

  const pageScroll = function () {
    const activeSection = sections.filter('.active');
    const nextSection = activeSection.next();
    const prevSection = activeSection.prev();

    return {
      next() {
        // есть ли секция снизу
        if (nextSection.length) {
          performTransition(nextSection.index());
        }
      },
      prev() {
        // есть ли секция сверху
        if (prevSection.length) {
          performTransition(prevSection.index());
        }
      }
    }

  };

  //обработка событий: 

  $(document).keydown(e => {
    const targetName = e.target.tagName.toLowerCase();
    const windowScroller = pageScroll();

    if (targetName === 'body') {

      if (e.key === "ArrowDown") {
        // console.log('arrow down');
        windowScroller.next();
      } else if (e.key === "ArrowUp") {
        windowScroller.prev();
        // console.log('arrow up');
      } else if (e.keyCode === 32) {
        // console.log("space");
        windowScroller.next();
      }
    }
  });

  $('[scroll-to]').on('click', (e) => {
    e.preventDefault();
    // console.log(e.currentTarget);
    let menuIndex = $(e.currentTarget).attr('scroll-to');
    performTransition(menuIndex);
  });

  $(window).on("wheel", (e) => {
    const deltaY = e.originalEvent.deltaY;
    const windowScroller = pageScroll();

    if (deltaY > 0) {
      windowScroller.next();
    }

    if (deltaY < 0) {
      windowScroller.prev();
    }
  });

  $('.scroll-down').on('click', e => {
    e.preventDefault();
    performTransition(1);
  });



  /// http://hgoebl.github.io/mobile-detect.js/
  const md = new MobileDetect(window.navigator.userAgent);
  const isMobile = md.mobile();
  // console.log(isMobile);

  if (isMobile) {
    // http://github.com/mattbryson/TouchSwipe-Jquery-Plugin
    $("body").swipe({
      //Generic swipe handler for all directions
      swipe: function (event, direction, distance, duration, fingerCount, fingerData) {
        // console.log("You swiped " + direction );
        const windowScroller = pageScroll();

        if (direction === 'up') {
          // console.log('up');
          windowScroller.next();
        }

        if (direction === 'down') {
          // console.log('down');
          windowScroller.prev();
        }
      }
    });
  }
  //

  //

  // yandex map
  let myMap;
  const init = () => {
    myMap = new ymaps.Map("map", {
      center: [59.938951, 30.315635],
      zoom: 11,
      controls: []
    });
    const coords = [
      [59.888834, 30.321793],
      [59.936620, 30.259454],
      [59.931454, 30.345764],
      [59.861381, 30.398845],
    ];
    const myCollection = new ymaps.GeoObjectCollection({}, {
      draggable: false,
      iconLayout: 'default#image',
      iconImageHref: './img/icons/map-marker.svg',
      iconImageSize: [46, 57],
      iconImageOffset: [-35, -52]
    });

    coords.forEach(coord => {
      myCollection.add(new ymaps.Placemark(coord));
    })

    myMap.geoObjects.add(myCollection);
    myMap.behaviors.disable('scrollZoom');
  };


  ymaps.ready(init);


}); //document ready


/// youtube player

let player;
const playerContainer = $(".player");

let eventsInit = () => {
  $(".player__start").click(e => {
    e.preventDefault();

    if (playerContainer.hasClass("paused")) {
      player.pauseVideo();
      console.log(player);

    } else {
      player.playVideo();
    }
  });

  $(".player__playback").click(e => {
    const bar = $(e.currentTarget);
    const clickedPosition = e.originalEvent.layerX;
    const newButtonPositionPercent = (clickedPosition / bar.width()) * 100;
    const newPlaybackPositionSec =
      (player.getDuration() / 100) * newButtonPositionPercent;

    $(".player__playback-button").css({
      left: `${newButtonPositionPercent}%`
    });

    player.seekTo(newPlaybackPositionSec);
  });

  $(".player__splash").click(e => {
    player.playVideo();
  })

  $(".player__volume-button").click(e => {
    if (player.isMuted()) {
      player.unMute();
      $(e.currentTarget).parent().removeClass("mute");
      $('.player__volume-level-button').css({
        left: `${(player.getVolume())}%`
      });
    } else {
      player.mute();
      $(e.currentTarget).parent().addClass("mute");
      $('.player__volume-level-button').css({
        left: 0
      });
    }
  });

  $('.player__volume-level').click(e => {
    const volumeLevel = $(e.currentTarget);
    const volumeLevelClickPosition = e.originalEvent.layerX;
    const newVolumeLevel = (volumeLevelClickPosition / volumeLevel.width()) * 100;
    player.setVolume(newVolumeLevel);

    if (newVolumeLevel === 0) {
      player.mute();
      $(".player__volume").addClass("mute");
      $('.player__volume-level-button').css({
        left: 0
      });
    } else {
      player.unMute();
      $(".player__volume").removeClass("mute");
      $('.player__volume-level-button').css({
        left: `${newVolumeLevel}%`
      });
    }
    // const newVolumeLevel = (player.getVolume())


  });
};

const formatTime = timeSec => {
  const roundTime = Math.round(timeSec);

  const minutes = addZero(Math.floor(roundTime / 60));
  const seconds = addZero(roundTime - minutes * 60);

  function addZero(num) {
    return num < 10 ? `0${num}` : num;
  }

  return `${minutes} : ${seconds}`;
};

const onPlayerReady = () => {
  let interval;
  const durationSec = player.getDuration();

  $(".player__duration-estimate").text(formatTime(durationSec));

  if (typeof interval !== "undefined") {
    clearInterval(interval);
  }

  interval = setInterval(() => {
    const completedSec = player.getCurrentTime();
    const completedPercent = (completedSec / durationSec) * 100;

    $(".player__playback-button").css({
      left: `${completedPercent}%`
    });

    $(".player__duration-completed").text(formatTime(completedSec));
  }, 1000);
};

const onPlayerStateChange = event => {
  /*
    -1 (воспроизведение видео не начато)
    0 (воспроизведение видео завершено)
    1 (воспроизведение)
    2 (пауза)
    3 (буферизация)
    5 (видео подают реплики).
  */
  switch (event.data) {
    case 1:
      playerContainer.addClass("active");
      playerContainer.addClass("paused");
      break;

    case 2:
      playerContainer.removeClass("active");
      playerContainer.removeClass("paused");
      break;
  }
};

function onYouTubeIframeAPIReady() {
  player = new YT.Player("yt-player", {
    height: $('.player').outerHeight(),
    width: $('.player').outerWidth(),
    videoId: "8paoyY8BTO0",
    events: {
      onReady: onPlayerReady,
      onStateChange: onPlayerStateChange
    },
    playerVars: {
      controls: 0,
      disablekb: 0,
      showinfo: 0,
      rel: 0,
      autoplay: 0,
      modestbranding: 0
    }
  });
}
console.log(player);

eventsInit();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJtYWluLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIiQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uICgpIHtcclxuICAvLyBXZSBsaXN0ZW4gdG8gdGhlIHJlc2l6ZSBldmVudFxyXG5cclxuICBsZXQgdmggPSB3aW5kb3cuaW5uZXJIZWlnaHQgKiAwLjAxO1xyXG4gIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZS5zZXRQcm9wZXJ0eSgnLS12aCcsIGAke3ZofXB4YCk7XHJcbiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsICgpID0+IHtcclxuICAgIC8vIFdlIGV4ZWN1dGUgdGhlIHNhbWUgc2NyaXB0IGFzIGJlZm9yZVxyXG4gICAgbGV0IHZoID0gd2luZG93LmlubmVySGVpZ2h0ICogMC4wMTtcclxuICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZS5zZXRQcm9wZXJ0eSgnLS12aCcsIGAke3ZofXB4YCk7XHJcbiAgfSk7XHJcbiAgY29uc29sZS5sb2codmgpO1xyXG5cclxuICAvLyBib3ggc2xpZGVyXHJcbiAgJCgnLnNsaWRlcm1lbnVfX2l0ZW1zJykuYnhTbGlkZXIoKTtcclxuXHJcblxyXG4gIC8vIGZ1bGxzY3JlZW4gbWVudVxyXG5cclxuICBjb25zdCBoYW1idXJnZXJNZW51ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5oYW1idXJnZXItbWVudS1saW5rXCIpO1xyXG4gIGNvbnN0IGZ1bGxTY3JlZW5NZW51ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5mdWxsc2NyZWVuLW1lbnVcIik7XHJcbiAgY29uc3QgZnVsbFNjcmVlbk1lbnVDbG9zZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuZnVsbHNjcmVlbi1tZW51X19jbG9zZVwiKTtcclxuXHJcbiAgaGFtYnVyZ2VyTWVudS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgZnVuY3Rpb24gKGUpIHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgIGZ1bGxTY3JlZW5NZW51LnN0eWxlLmRpc3BsYXkgPSBcImZsZXhcIjtcclxuICB9KTtcclxuXHJcbiAgZnVsbFNjcmVlbk1lbnVDbG9zZS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgZnVuY3Rpb24gKGUpIHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgIGZ1bGxTY3JlZW5NZW51LnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcclxuICB9KTtcclxuXHJcbiAgJChcIi5tZW51X19saW5rXCIpLm9uKCdjbGljaycsIGUgPT4ge1xyXG4gICAgJChmdWxsU2NyZWVuTWVudSkuY3NzKHsgJ2Rpc3BsYXknOiAnbm9uZScgfSk7XHJcbiAgfSlcclxuXHJcblxyXG5cclxuICAvLyB0ZWFtIHNlY3Rpb25cclxuICBsZXQgdGVhbUl0ZW1zID0gJCgnLnRlYW1fX2l0ZW0nKTtcclxuICBsZXQgdGVhbUl0ZW1MaW5rID0gJCgnLnRlYW1fX2xpbmsnKTtcclxuXHJcbiAgJCgnLnRlYW1fX2xpbmsnKS5vbignY2xpY2snLCAoZSkgPT4ge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cclxuICAgICQoZS5jdXJyZW50VGFyZ2V0KS5jbG9zZXN0KCcudGVhbV9faXRlbScpLnRvZ2dsZUNsYXNzKCd0ZWFtX19pdGVtLS1hY3RpdmUnKTtcclxuICAgICQoZS5jdXJyZW50VGFyZ2V0KS5jbG9zZXN0KCcudGVhbV9faXRlbScpLnNpYmxpbmdzKCcudGVhbV9faXRlbScpLnJlbW92ZUNsYXNzKCd0ZWFtX19pdGVtLS1hY3RpdmUnKTtcclxuICB9KVxyXG5cclxuICAvL2J1cmdlciBtZW51XHJcblxyXG4gICQoJy5idXJnZXJtZW51X190cmlnZ2VyJykub24oJ2NsaWNrJywgZSA9PiB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcblxyXG4gICAgJChlLmN1cnJlbnRUYXJnZXQpLmNsb3Nlc3QoJy5idXJnZXJtZW51X19pdGVtJykudG9nZ2xlQ2xhc3MoJ2J1cmdlcm1lbnVfX2l0ZW0tLWFjdGl2ZScpO1xyXG4gICAgJChlLmN1cnJlbnRUYXJnZXQpLmNsb3Nlc3QoJy5idXJnZXJtZW51X19pdGVtJykuc2libGluZ3MoJy5idXJnZXJtZW51X19pdGVtJykucmVtb3ZlQ2xhc3MoJ2J1cmdlcm1lbnVfX2l0ZW0tLWFjdGl2ZScpO1xyXG4gIH0pXHJcblxyXG4gICQoJy5idXJnZXJtZW51X19jbG9zZScpLm9uKCdjbGljaycsIGUgPT4ge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cclxuICAgICQoJy5idXJnZXJtZW51X190cmlnZ2VyJykuY2xpY2soKTtcclxuICB9KTtcclxuICAvLyBvcmRlciBtZW51XHJcblxyXG4gIGNvbnN0IG9yZGVyRm9ybSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5vcmRlckZvcm0nKTtcclxuICBjb25zdCBvcmRlckJ0biA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNvcmRlcl9fYnRuJyk7XHJcblxyXG4gIG9yZGVyQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgIC8vIGNvbnNvbGUubG9nKG9yZGVyRm9ybS5lbGVtZW50cy5uYW1lLnZhbHVlKTtcclxuICAgIGlmICh2YWxpZGF0ZUZvcm0ob3JkZXJGb3JtKSkge1xyXG4gICAgICAvLyBjb25zb2xlLmxvZygndnNldyBvaycpO1xyXG4gICAgICBjb25zdCBkYXRhID0ge1xyXG4gICAgICAgIG5hbWU6IG9yZGVyRm9ybS5lbGVtZW50cy5uYW1lLnZhbHVlLFxyXG4gICAgICAgIHBob25lOiBvcmRlckZvcm0uZWxlbWVudHMucGhvbmUudmFsdWUsXHJcbiAgICAgICAgY29tbWVudDogb3JkZXJGb3JtLmVsZW1lbnRzLmNvbW1lbnQudmFsdWUsXHJcbiAgICAgICAgdG86ICdzb21lLW1haWxAbWFpbC5jb20nIC8vINCf0L4g0LfQsNC00LDQvdC40Y4g0YHQtdGA0LLQtdGAINC/0YDQuNC90LjQvNCw0LXRgiDRh9C10YLRi9GA0LUg0L/QsNGA0LDQvNC10YLRgNCwLCDQstC60LvRjtGH0LDRjyBlbWFpbC4gXHJcbiAgICAgICAgLy8g0J3QviDQv9C+INC80LDQutC10YLRgyDQsiDRhNC+0YDQvNC1IGVtYWlsINC+0L0g0L7RgtGB0YPRgtGB0YLQstGD0LXRgi5cclxuICAgICAgfVxyXG4gICAgICBjb25zdCB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcclxuICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9ICdqc29uJztcclxuICAgICAgeGhyLm9wZW4oJ1BPU1QnLCAnaHR0cHM6Ly93ZWJkZXYtYXBpLmxvZnRzY2hvb2wuY29tL3NlbmRtYWlsJyk7XHJcbiAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdjb250ZW50LXR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xyXG4gICAgICB4aHIuc2VuZChKU09OLnN0cmluZ2lmeShkYXRhKSk7XHJcbiAgICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKCkgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKHhoci5yZXNwb25zZS5tZXNzYWdlKTtcclxuICAgICAgICBvdmVybGF5T3JkZXIub3BlbigpO1xyXG4gICAgICAgIG92ZXJsYXlPcmRlci5zZXRDb250ZW50KHhoci5yZXNwb25zZS5tZXNzYWdlKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gIGZ1bmN0aW9uIHZhbGlkYXRlRm9ybShmb3JtKSB7XHJcbiAgICBsZXQgdmFsaWQgPSB0cnVlO1xyXG5cclxuICAgIGlmICghdmFsaWRhdGVGaWVsZChmb3JtLmVsZW1lbnRzLm5hbWUpKSB7XHJcbiAgICAgIHZhbGlkID0gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCF2YWxpZGF0ZUZpZWxkKGZvcm0uZWxlbWVudHMucGhvbmUpKSB7XHJcbiAgICAgIHZhbGlkID0gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCF2YWxpZGF0ZUZpZWxkKGZvcm0uZWxlbWVudHMuY29tbWVudCkpIHtcclxuICAgICAgdmFsaWQgPSBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdmFsaWQ7XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiB2YWxpZGF0ZUZpZWxkKGZpZWxkKSB7XHJcbiAgICAvLyBmaWVsZC5uZXh0RWxlbWVudFNpYmxpbmcudGV4dENvbnRlbnQgPSBmaWVsZC52YWxpZGF0aW9uTWVzc2FnZTtcclxuICAgIGlmIChmaWVsZC5jaGVja1ZhbGlkaXR5KCkpIHtcclxuICAgICAgJChmaWVsZCkuY3NzKCdib3JkZXItY29sb3InLCAndHJhbnNwYXJlbnQnKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICQoZmllbGQpLmNzcygnYm9yZGVyLWNvbG9yJywgJ3JlZCcpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZpZWxkLmNoZWNrVmFsaWRpdHkoKTtcclxuICB9XHJcblxyXG5cclxuICAvL292ZXJsYXlcclxuXHJcbiAgLy8gY29uc3Qgb3Blbk92ZXJsYXkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjb3Blbk92ZXJsYXknKTtcclxuICBjb25zdCB0YW1wbGF0ZU9yZGVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI292ZXJsYXlPcmRlcicpLmlubmVySFRNTDtcclxuICBjb25zdCBvdmVybGF5T3JkZXIgPSBjcmVhdGVPdmVybGF5KHRhbXBsYXRlT3JkZXIsICd0YW1wbGF0ZU9yZGVyJyk7XHJcblxyXG4gIC8vIG9wZW5PdmVybGF5LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZSA9PiB7XHJcbiAgLy8gICBvdmVybGF5Lm9wZW4oKTtcclxuICAvLyAgIG92ZXJsYXkuc2V0Q29udGVudCgnVnNlIG9rJyk7XHJcbiAgLy8gfSk7XHJcblxyXG4gIGZ1bmN0aW9uIGNyZWF0ZU92ZXJsYXkodGFtcGxhdGUsIGNsYXNzVGFtcGxhdGUpIHtcclxuICAgIGNvbnN0IGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICBmcmFnbWVudC5pbm5lckhUTUwgPSB0YW1wbGF0ZTtcclxuXHJcbiAgICBjb25zdCBvdmVybGF5RWxlbWVudCA9IGZyYWdtZW50LnF1ZXJ5U2VsZWN0b3IoJy5vdmVybGF5Jyk7XHJcbiAgICBjb25zdCBjb250YWluZXJFbGVtZW50ID0gZnJhZ21lbnQucXVlcnlTZWxlY3RvcignLm92ZXJsYXlfX2NvbnRhaW5lcicpO1xyXG4gICAgY29udGFpbmVyRWxlbWVudC5jbGFzc0xpc3QuYWRkKGNsYXNzVGFtcGxhdGUpO1xyXG4gICAgY29uc3QgY2xvc2VFbGVtZW50ID0gZnJhZ21lbnQucXVlcnlTZWxlY3RvcignLm92ZXJsYXlfX2Nsb3NlJyk7XHJcbiAgICBjb25zdCBjb250ZW50RWxlbWVudCA9IGZyYWdtZW50LnF1ZXJ5U2VsZWN0b3IoJy5vdmVybGF5X19jb250ZW50Jyk7XHJcblxyXG4gICAgb3ZlcmxheUVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHtcclxuICAgICAgaWYgKGUudGFyZ2V0ID09PSBvdmVybGF5RWxlbWVudCkge1xyXG4gICAgICAgIGNsb3NlRWxlbWVudC5jbGljaygpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBjbG9zZUVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4ge1xyXG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQob3ZlcmxheUVsZW1lbnQpO1xyXG4gICAgfSlcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBvcGVuKCkge1xyXG4gICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQob3ZlcmxheUVsZW1lbnQpO1xyXG4gICAgICB9LFxyXG4gICAgICBjbG9zZSgpIHtcclxuICAgICAgICBjbG9zZUVsZW1lbnQuY2xpY2soKTtcclxuICAgICAgfSxcclxuICAgICAgc2V0Q29udGVudChjb250ZW50KSB7XHJcbiAgICAgICAgY29udGVudEVsZW1lbnQuaW5uZXJIVE1MID0gY29udGVudDtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICB9XHJcblxyXG4gIC8vIHJldmlld3MgXHJcbiAgY29uc3QgdGFtcGxhdGVSZXZpZXcgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjb3ZlcmxheVJldmlldycpLmlubmVySFRNTDtcclxuICBjb25zdCBvdmVybGF5UmV2aWV3ID0gY3JlYXRlT3ZlcmxheSh0YW1wbGF0ZVJldmlldyk7XHJcblxyXG4gIGNvbnN0IHJldmlld092ZXJsYXlCdG4gPSAkKCcucmV2aWV3X19idG4nKTtcclxuXHJcbiAgcmV2aWV3T3ZlcmxheUJ0bi5vbignY2xpY2snLCBlID0+IHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgIGxldCByZXZpZXdDb250ZW50ID0gJChlLmN1cnJlbnRUYXJnZXQpLnNpYmxpbmdzKCcucmV2aWV3X19jb250ZW50JykucHJvcCgnb3V0ZXJIVE1MJyk7XHJcblxyXG4gICAgb3ZlcmxheVJldmlldy5vcGVuKCk7XHJcbiAgICBvdmVybGF5UmV2aWV3LnNldENvbnRlbnQocmV2aWV3Q29udGVudCk7XHJcbiAgfSlcclxuXHJcbiAgLy9vbmUgcGFnZSBzY3JvbGxcclxuICBjb25zdCBzZWN0aW9ucyA9ICQoJy5zZWN0aW9uJyk7XHJcbiAgY29uc3QgZGlzcGxheSA9ICQoJy5tYWluY29udGVudCcpO1xyXG5cclxuICBsZXQgaW5TY3JvbGwgPSBmYWxzZTsgLy8g0LXRgdGC0Ywg0LvQuCDQv9C10YDQtdC80LXRidC10L3QuNC1XHJcblxyXG5cclxuICBjb25zdCBjb3VudFNlY3Rpb25Qb3NpdGlvbiA9IChzZWN0aW9uSW5kZXgpID0+IHtcclxuICAgIGNvbnN0IHBvc2l0aW9uID0gc2VjdGlvbkluZGV4ICogKC0xMDApO1xyXG4gICAgLy8gY29uc29sZS5sb2cocG9zaXRpb24pO1xyXG4gICAgaWYgKGlzTmFOKHBvc2l0aW9uKSkge1xyXG4gICAgICBjb25zb2xlLmVycm9yKFwi0L/QtdGA0LXQtNCw0L3QviDQvdC1INCy0LXRgNC90L7QtSDQt9C90LDRh9C10L3QuNC1INCyIGNvdW50U2VjdGlvblBvc2l0b25cIik7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcG9zaXRpb247XHJcblxyXG4gIH1cclxuXHJcbiAgY29uc3QgcmVzZXRBY3RpdmVDbGFzcyA9IGZ1bmN0aW9uIChzZWN0aW9uLCBzZWN0aW9uSW5kZXgpIHtcclxuICAgIHNlY3Rpb24uZXEoc2VjdGlvbkluZGV4KS5hZGRDbGFzcygnYWN0aXZlJykuc2libGluZ3MoKS5yZW1vdmVDbGFzcygnYWN0aXZlJyk7XHJcbiAgICAkKCcuZml4ZWQtbWVudV9faXRlbScpLmVxKHNlY3Rpb25JbmRleCkuYWRkQ2xhc3MoJ2FjdGl2ZScpLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpO1xyXG4gIH07XHJcblxyXG4gIGNvbnN0IHBlcmZvcm1UcmFuc2l0aW9uID0gKHNlY3Rpb25JbmRleCkgPT4ge1xyXG4gICAgaWYgKGluU2Nyb2xsKSByZXR1cm47IC8vINC/0YDQvtCy0LXRgNGP0LXQvCAsINC10YHRgtGMINC70Lgg0L/QtdGA0LXQvNC10YnQtdC90LjQtSDRgdC10LnRh9Cw0YFcclxuICAgIGluU2Nyb2xsID0gdHJ1ZTsgLy/RgNCw0LfRgNC10YjQsNC10Lwg0L/QtdGA0LXQvNC10YnQtdC90LjQtVxyXG4gICAgLy/QvtC/0YDQtdC00LXQu9GP0LXQvCDQv9C+0LfQuNGG0LjRjiDRgdC10LrRhtC40Lgg0Lgg0YDQsNGB0YfQuNGC0YvQstCw0LXQvCDQt9C90LDRh9C10L3QuNC1INC/0LXRgNC10LzQtdGJ0LXQvdC40Y9cclxuICAgIGNvbnN0IHBvc2l0aW9uID0gY291bnRTZWN0aW9uUG9zaXRpb24oc2VjdGlvbkluZGV4KTtcclxuICAgIGNvbnN0IHRyYXNpdGlvbk92ZXIgPSA1MDA7IC8vINCy0YDQtdC80Y8g0LfQsNC00LXRgNC20LrQuFxyXG5cclxuICAgIC8v0LzQtdC90Y/QtdC8INCw0LrRgtC40LLQvdGL0Lkg0LrQu9Cw0YHRgVxyXG4gICAgcmVzZXRBY3RpdmVDbGFzcyhzZWN0aW9ucywgc2VjdGlvbkluZGV4KTtcclxuXHJcbiAgICAvL9C/0LXRgNC10LzQtdGJ0Y/QtdC8IG1haW5jb250ZW50INC90LAg0YPQutCw0LfQsNC90L3Rg9GOINC/0L7Qt9C40YbQuNGOXHJcbiAgICBkaXNwbGF5LmNzcyh7XHJcbiAgICAgIHRyYW5zZm9ybTogYHRyYW5zbGF0ZVkoJHtwb3NpdGlvbn0lKWAsXHJcbiAgICB9KTtcclxuXHJcbiAgICAvL9GD0YHRgtCw0L3QsNCy0LvQuNCy0LDQtdC8INCy0YDQtdC80Y8g0LfQsNC00LXRgNC20LrQuFxyXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgIGluU2Nyb2xsID0gZmFsc2U7IC8v0LfQsNC/0YDQtdGJ0Y/QtdC8INC/0LXRgNC10LzQtdGJ0LXQvdC40LVcclxuICAgICAgLy8gcmVzZXRBY3RpdmVDbGFzcygkKFwiLmZpeGVkLW1lbnVfX2l0ZW1cIiksIHNlY3Rpb25FcSk7XHJcbiAgICB9LCB0cmFzaXRpb25PdmVyKTtcclxuXHJcbiAgfVxyXG5cclxuICBjb25zdCBwYWdlU2Nyb2xsID0gZnVuY3Rpb24gKCkge1xyXG4gICAgY29uc3QgYWN0aXZlU2VjdGlvbiA9IHNlY3Rpb25zLmZpbHRlcignLmFjdGl2ZScpO1xyXG4gICAgY29uc3QgbmV4dFNlY3Rpb24gPSBhY3RpdmVTZWN0aW9uLm5leHQoKTtcclxuICAgIGNvbnN0IHByZXZTZWN0aW9uID0gYWN0aXZlU2VjdGlvbi5wcmV2KCk7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgbmV4dCgpIHtcclxuICAgICAgICAvLyDQtdGB0YLRjCDQu9C4INGB0LXQutGG0LjRjyDRgdC90LjQt9GDXHJcbiAgICAgICAgaWYgKG5leHRTZWN0aW9uLmxlbmd0aCkge1xyXG4gICAgICAgICAgcGVyZm9ybVRyYW5zaXRpb24obmV4dFNlY3Rpb24uaW5kZXgoKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9LFxyXG4gICAgICBwcmV2KCkge1xyXG4gICAgICAgIC8vINC10YHRgtGMINC70Lgg0YHQtdC60YbQuNGPINGB0LLQtdGA0YXRg1xyXG4gICAgICAgIGlmIChwcmV2U2VjdGlvbi5sZW5ndGgpIHtcclxuICAgICAgICAgIHBlcmZvcm1UcmFuc2l0aW9uKHByZXZTZWN0aW9uLmluZGV4KCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICB9O1xyXG5cclxuICAvL9C+0LHRgNCw0LHQvtGC0LrQsCDRgdC+0LHRi9GC0LjQuTogXHJcblxyXG4gICQoZG9jdW1lbnQpLmtleWRvd24oZSA9PiB7XHJcbiAgICBjb25zdCB0YXJnZXROYW1lID0gZS50YXJnZXQudGFnTmFtZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgY29uc3Qgd2luZG93U2Nyb2xsZXIgPSBwYWdlU2Nyb2xsKCk7XHJcblxyXG4gICAgaWYgKHRhcmdldE5hbWUgPT09ICdib2R5Jykge1xyXG5cclxuICAgICAgaWYgKGUua2V5ID09PSBcIkFycm93RG93blwiKSB7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ2Fycm93IGRvd24nKTtcclxuICAgICAgICB3aW5kb3dTY3JvbGxlci5uZXh0KCk7XHJcbiAgICAgIH0gZWxzZSBpZiAoZS5rZXkgPT09IFwiQXJyb3dVcFwiKSB7XHJcbiAgICAgICAgd2luZG93U2Nyb2xsZXIucHJldigpO1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCdhcnJvdyB1cCcpO1xyXG4gICAgICB9IGVsc2UgaWYgKGUua2V5Q29kZSA9PT0gMzIpIHtcclxuICAgICAgICAvLyBjb25zb2xlLmxvZyhcInNwYWNlXCIpO1xyXG4gICAgICAgIHdpbmRvd1Njcm9sbGVyLm5leHQoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICAkKCdbc2Nyb2xsLXRvXScpLm9uKCdjbGljaycsIChlKSA9PiB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAvLyBjb25zb2xlLmxvZyhlLmN1cnJlbnRUYXJnZXQpO1xyXG4gICAgbGV0IG1lbnVJbmRleCA9ICQoZS5jdXJyZW50VGFyZ2V0KS5hdHRyKCdzY3JvbGwtdG8nKTtcclxuICAgIHBlcmZvcm1UcmFuc2l0aW9uKG1lbnVJbmRleCk7XHJcbiAgfSk7XHJcblxyXG4gICQod2luZG93KS5vbihcIndoZWVsXCIsIChlKSA9PiB7XHJcbiAgICBjb25zdCBkZWx0YVkgPSBlLm9yaWdpbmFsRXZlbnQuZGVsdGFZO1xyXG4gICAgY29uc3Qgd2luZG93U2Nyb2xsZXIgPSBwYWdlU2Nyb2xsKCk7XHJcblxyXG4gICAgaWYgKGRlbHRhWSA+IDApIHtcclxuICAgICAgd2luZG93U2Nyb2xsZXIubmV4dCgpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChkZWx0YVkgPCAwKSB7XHJcbiAgICAgIHdpbmRvd1Njcm9sbGVyLnByZXYoKTtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgJCgnLnNjcm9sbC1kb3duJykub24oJ2NsaWNrJywgZSA9PiB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICBwZXJmb3JtVHJhbnNpdGlvbigxKTtcclxuICB9KTtcclxuXHJcblxyXG5cclxuICAvLy8gaHR0cDovL2hnb2VibC5naXRodWIuaW8vbW9iaWxlLWRldGVjdC5qcy9cclxuICBjb25zdCBtZCA9IG5ldyBNb2JpbGVEZXRlY3Qod2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQpO1xyXG4gIGNvbnN0IGlzTW9iaWxlID0gbWQubW9iaWxlKCk7XHJcbiAgLy8gY29uc29sZS5sb2coaXNNb2JpbGUpO1xyXG5cclxuICBpZiAoaXNNb2JpbGUpIHtcclxuICAgIC8vIGh0dHA6Ly9naXRodWIuY29tL21hdHRicnlzb24vVG91Y2hTd2lwZS1KcXVlcnktUGx1Z2luXHJcbiAgICAkKFwiYm9keVwiKS5zd2lwZSh7XHJcbiAgICAgIC8vR2VuZXJpYyBzd2lwZSBoYW5kbGVyIGZvciBhbGwgZGlyZWN0aW9uc1xyXG4gICAgICBzd2lwZTogZnVuY3Rpb24gKGV2ZW50LCBkaXJlY3Rpb24sIGRpc3RhbmNlLCBkdXJhdGlvbiwgZmluZ2VyQ291bnQsIGZpbmdlckRhdGEpIHtcclxuICAgICAgICAvLyBjb25zb2xlLmxvZyhcIllvdSBzd2lwZWQgXCIgKyBkaXJlY3Rpb24gKTtcclxuICAgICAgICBjb25zdCB3aW5kb3dTY3JvbGxlciA9IHBhZ2VTY3JvbGwoKTtcclxuXHJcbiAgICAgICAgaWYgKGRpcmVjdGlvbiA9PT0gJ3VwJykge1xyXG4gICAgICAgICAgLy8gY29uc29sZS5sb2coJ3VwJyk7XHJcbiAgICAgICAgICB3aW5kb3dTY3JvbGxlci5uZXh0KCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoZGlyZWN0aW9uID09PSAnZG93bicpIHtcclxuICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdkb3duJyk7XHJcbiAgICAgICAgICB3aW5kb3dTY3JvbGxlci5wcmV2KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLy9cclxuXHJcbiAgLy9cclxuXHJcbiAgLy8geWFuZGV4IG1hcFxyXG4gIGxldCBteU1hcDtcclxuICBjb25zdCBpbml0ID0gKCkgPT4ge1xyXG4gICAgbXlNYXAgPSBuZXcgeW1hcHMuTWFwKFwibWFwXCIsIHtcclxuICAgICAgY2VudGVyOiBbNTkuOTM4OTUxLCAzMC4zMTU2MzVdLFxyXG4gICAgICB6b29tOiAxMSxcclxuICAgICAgY29udHJvbHM6IFtdXHJcbiAgICB9KTtcclxuICAgIGNvbnN0IGNvb3JkcyA9IFtcclxuICAgICAgWzU5Ljg4ODgzNCwgMzAuMzIxNzkzXSxcclxuICAgICAgWzU5LjkzNjYyMCwgMzAuMjU5NDU0XSxcclxuICAgICAgWzU5LjkzMTQ1NCwgMzAuMzQ1NzY0XSxcclxuICAgICAgWzU5Ljg2MTM4MSwgMzAuMzk4ODQ1XSxcclxuICAgIF07XHJcbiAgICBjb25zdCBteUNvbGxlY3Rpb24gPSBuZXcgeW1hcHMuR2VvT2JqZWN0Q29sbGVjdGlvbih7fSwge1xyXG4gICAgICBkcmFnZ2FibGU6IGZhbHNlLFxyXG4gICAgICBpY29uTGF5b3V0OiAnZGVmYXVsdCNpbWFnZScsXHJcbiAgICAgIGljb25JbWFnZUhyZWY6ICcuL2ltZy9pY29ucy9tYXAtbWFya2VyLnN2ZycsXHJcbiAgICAgIGljb25JbWFnZVNpemU6IFs0NiwgNTddLFxyXG4gICAgICBpY29uSW1hZ2VPZmZzZXQ6IFstMzUsIC01Ml1cclxuICAgIH0pO1xyXG5cclxuICAgIGNvb3Jkcy5mb3JFYWNoKGNvb3JkID0+IHtcclxuICAgICAgbXlDb2xsZWN0aW9uLmFkZChuZXcgeW1hcHMuUGxhY2VtYXJrKGNvb3JkKSk7XHJcbiAgICB9KVxyXG5cclxuICAgIG15TWFwLmdlb09iamVjdHMuYWRkKG15Q29sbGVjdGlvbik7XHJcbiAgICBteU1hcC5iZWhhdmlvcnMuZGlzYWJsZSgnc2Nyb2xsWm9vbScpO1xyXG4gIH07XHJcblxyXG5cclxuICB5bWFwcy5yZWFkeShpbml0KTtcclxuXHJcblxyXG59KTsgLy9kb2N1bWVudCByZWFkeVxyXG5cclxuXHJcbi8vLyB5b3V0dWJlIHBsYXllclxyXG5cclxubGV0IHBsYXllcjtcclxuY29uc3QgcGxheWVyQ29udGFpbmVyID0gJChcIi5wbGF5ZXJcIik7XHJcblxyXG5sZXQgZXZlbnRzSW5pdCA9ICgpID0+IHtcclxuICAkKFwiLnBsYXllcl9fc3RhcnRcIikuY2xpY2soZSA9PiB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcblxyXG4gICAgaWYgKHBsYXllckNvbnRhaW5lci5oYXNDbGFzcyhcInBhdXNlZFwiKSkge1xyXG4gICAgICBwbGF5ZXIucGF1c2VWaWRlbygpO1xyXG4gICAgICBjb25zb2xlLmxvZyhwbGF5ZXIpO1xyXG5cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHBsYXllci5wbGF5VmlkZW8oKTtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgJChcIi5wbGF5ZXJfX3BsYXliYWNrXCIpLmNsaWNrKGUgPT4ge1xyXG4gICAgY29uc3QgYmFyID0gJChlLmN1cnJlbnRUYXJnZXQpO1xyXG4gICAgY29uc3QgY2xpY2tlZFBvc2l0aW9uID0gZS5vcmlnaW5hbEV2ZW50LmxheWVyWDtcclxuICAgIGNvbnN0IG5ld0J1dHRvblBvc2l0aW9uUGVyY2VudCA9IChjbGlja2VkUG9zaXRpb24gLyBiYXIud2lkdGgoKSkgKiAxMDA7XHJcbiAgICBjb25zdCBuZXdQbGF5YmFja1Bvc2l0aW9uU2VjID1cclxuICAgICAgKHBsYXllci5nZXREdXJhdGlvbigpIC8gMTAwKSAqIG5ld0J1dHRvblBvc2l0aW9uUGVyY2VudDtcclxuXHJcbiAgICAkKFwiLnBsYXllcl9fcGxheWJhY2stYnV0dG9uXCIpLmNzcyh7XHJcbiAgICAgIGxlZnQ6IGAke25ld0J1dHRvblBvc2l0aW9uUGVyY2VudH0lYFxyXG4gICAgfSk7XHJcblxyXG4gICAgcGxheWVyLnNlZWtUbyhuZXdQbGF5YmFja1Bvc2l0aW9uU2VjKTtcclxuICB9KTtcclxuXHJcbiAgJChcIi5wbGF5ZXJfX3NwbGFzaFwiKS5jbGljayhlID0+IHtcclxuICAgIHBsYXllci5wbGF5VmlkZW8oKTtcclxuICB9KVxyXG5cclxuICAkKFwiLnBsYXllcl9fdm9sdW1lLWJ1dHRvblwiKS5jbGljayhlID0+IHtcclxuICAgIGlmIChwbGF5ZXIuaXNNdXRlZCgpKSB7XHJcbiAgICAgIHBsYXllci51bk11dGUoKTtcclxuICAgICAgJChlLmN1cnJlbnRUYXJnZXQpLnBhcmVudCgpLnJlbW92ZUNsYXNzKFwibXV0ZVwiKTtcclxuICAgICAgJCgnLnBsYXllcl9fdm9sdW1lLWxldmVsLWJ1dHRvbicpLmNzcyh7XHJcbiAgICAgICAgbGVmdDogYCR7KHBsYXllci5nZXRWb2x1bWUoKSl9JWBcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBwbGF5ZXIubXV0ZSgpO1xyXG4gICAgICAkKGUuY3VycmVudFRhcmdldCkucGFyZW50KCkuYWRkQ2xhc3MoXCJtdXRlXCIpO1xyXG4gICAgICAkKCcucGxheWVyX192b2x1bWUtbGV2ZWwtYnV0dG9uJykuY3NzKHtcclxuICAgICAgICBsZWZ0OiAwXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICAkKCcucGxheWVyX192b2x1bWUtbGV2ZWwnKS5jbGljayhlID0+IHtcclxuICAgIGNvbnN0IHZvbHVtZUxldmVsID0gJChlLmN1cnJlbnRUYXJnZXQpO1xyXG4gICAgY29uc3Qgdm9sdW1lTGV2ZWxDbGlja1Bvc2l0aW9uID0gZS5vcmlnaW5hbEV2ZW50LmxheWVyWDtcclxuICAgIGNvbnN0IG5ld1ZvbHVtZUxldmVsID0gKHZvbHVtZUxldmVsQ2xpY2tQb3NpdGlvbiAvIHZvbHVtZUxldmVsLndpZHRoKCkpICogMTAwO1xyXG4gICAgcGxheWVyLnNldFZvbHVtZShuZXdWb2x1bWVMZXZlbCk7XHJcblxyXG4gICAgaWYgKG5ld1ZvbHVtZUxldmVsID09PSAwKSB7XHJcbiAgICAgIHBsYXllci5tdXRlKCk7XHJcbiAgICAgICQoXCIucGxheWVyX192b2x1bWVcIikuYWRkQ2xhc3MoXCJtdXRlXCIpO1xyXG4gICAgICAkKCcucGxheWVyX192b2x1bWUtbGV2ZWwtYnV0dG9uJykuY3NzKHtcclxuICAgICAgICBsZWZ0OiAwXHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcGxheWVyLnVuTXV0ZSgpO1xyXG4gICAgICAkKFwiLnBsYXllcl9fdm9sdW1lXCIpLnJlbW92ZUNsYXNzKFwibXV0ZVwiKTtcclxuICAgICAgJCgnLnBsYXllcl9fdm9sdW1lLWxldmVsLWJ1dHRvbicpLmNzcyh7XHJcbiAgICAgICAgbGVmdDogYCR7bmV3Vm9sdW1lTGV2ZWx9JWBcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICAvLyBjb25zdCBuZXdWb2x1bWVMZXZlbCA9IChwbGF5ZXIuZ2V0Vm9sdW1lKCkpXHJcblxyXG5cclxuICB9KTtcclxufTtcclxuXHJcbmNvbnN0IGZvcm1hdFRpbWUgPSB0aW1lU2VjID0+IHtcclxuICBjb25zdCByb3VuZFRpbWUgPSBNYXRoLnJvdW5kKHRpbWVTZWMpO1xyXG5cclxuICBjb25zdCBtaW51dGVzID0gYWRkWmVybyhNYXRoLmZsb29yKHJvdW5kVGltZSAvIDYwKSk7XHJcbiAgY29uc3Qgc2Vjb25kcyA9IGFkZFplcm8ocm91bmRUaW1lIC0gbWludXRlcyAqIDYwKTtcclxuXHJcbiAgZnVuY3Rpb24gYWRkWmVybyhudW0pIHtcclxuICAgIHJldHVybiBudW0gPCAxMCA/IGAwJHtudW19YCA6IG51bTtcclxuICB9XHJcblxyXG4gIHJldHVybiBgJHttaW51dGVzfSA6ICR7c2Vjb25kc31gO1xyXG59O1xyXG5cclxuY29uc3Qgb25QbGF5ZXJSZWFkeSA9ICgpID0+IHtcclxuICBsZXQgaW50ZXJ2YWw7XHJcbiAgY29uc3QgZHVyYXRpb25TZWMgPSBwbGF5ZXIuZ2V0RHVyYXRpb24oKTtcclxuXHJcbiAgJChcIi5wbGF5ZXJfX2R1cmF0aW9uLWVzdGltYXRlXCIpLnRleHQoZm9ybWF0VGltZShkdXJhdGlvblNlYykpO1xyXG5cclxuICBpZiAodHlwZW9mIGludGVydmFsICE9PSBcInVuZGVmaW5lZFwiKSB7XHJcbiAgICBjbGVhckludGVydmFsKGludGVydmFsKTtcclxuICB9XHJcblxyXG4gIGludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xyXG4gICAgY29uc3QgY29tcGxldGVkU2VjID0gcGxheWVyLmdldEN1cnJlbnRUaW1lKCk7XHJcbiAgICBjb25zdCBjb21wbGV0ZWRQZXJjZW50ID0gKGNvbXBsZXRlZFNlYyAvIGR1cmF0aW9uU2VjKSAqIDEwMDtcclxuXHJcbiAgICAkKFwiLnBsYXllcl9fcGxheWJhY2stYnV0dG9uXCIpLmNzcyh7XHJcbiAgICAgIGxlZnQ6IGAke2NvbXBsZXRlZFBlcmNlbnR9JWBcclxuICAgIH0pO1xyXG5cclxuICAgICQoXCIucGxheWVyX19kdXJhdGlvbi1jb21wbGV0ZWRcIikudGV4dChmb3JtYXRUaW1lKGNvbXBsZXRlZFNlYykpO1xyXG4gIH0sIDEwMDApO1xyXG59O1xyXG5cclxuY29uc3Qgb25QbGF5ZXJTdGF0ZUNoYW5nZSA9IGV2ZW50ID0+IHtcclxuICAvKlxyXG4gICAgLTEgKNCy0L7RgdC/0YDQvtC40LfQstC10LTQtdC90LjQtSDQstC40LTQtdC+INC90LUg0L3QsNGH0LDRgtC+KVxyXG4gICAgMCAo0LLQvtGB0L/RgNC+0LjQt9Cy0LXQtNC10L3QuNC1INCy0LjQtNC10L4g0LfQsNCy0LXRgNGI0LXQvdC+KVxyXG4gICAgMSAo0LLQvtGB0L/RgNC+0LjQt9Cy0LXQtNC10L3QuNC1KVxyXG4gICAgMiAo0L/QsNGD0LfQsClcclxuICAgIDMgKNCx0YPRhNC10YDQuNC30LDRhtC40Y8pXHJcbiAgICA1ICjQstC40LTQtdC+INC/0L7QtNCw0Y7RgiDRgNC10L/Qu9C40LrQuCkuXHJcbiAgKi9cclxuICBzd2l0Y2ggKGV2ZW50LmRhdGEpIHtcclxuICAgIGNhc2UgMTpcclxuICAgICAgcGxheWVyQ29udGFpbmVyLmFkZENsYXNzKFwiYWN0aXZlXCIpO1xyXG4gICAgICBwbGF5ZXJDb250YWluZXIuYWRkQ2xhc3MoXCJwYXVzZWRcIik7XHJcbiAgICAgIGJyZWFrO1xyXG5cclxuICAgIGNhc2UgMjpcclxuICAgICAgcGxheWVyQ29udGFpbmVyLnJlbW92ZUNsYXNzKFwiYWN0aXZlXCIpO1xyXG4gICAgICBwbGF5ZXJDb250YWluZXIucmVtb3ZlQ2xhc3MoXCJwYXVzZWRcIik7XHJcbiAgICAgIGJyZWFrO1xyXG4gIH1cclxufTtcclxuXHJcbmZ1bmN0aW9uIG9uWW91VHViZUlmcmFtZUFQSVJlYWR5KCkge1xyXG4gIHBsYXllciA9IG5ldyBZVC5QbGF5ZXIoXCJ5dC1wbGF5ZXJcIiwge1xyXG4gICAgaGVpZ2h0OiAkKCcucGxheWVyJykub3V0ZXJIZWlnaHQoKSxcclxuICAgIHdpZHRoOiAkKCcucGxheWVyJykub3V0ZXJXaWR0aCgpLFxyXG4gICAgdmlkZW9JZDogXCI4cGFveVk4QlRPMFwiLFxyXG4gICAgZXZlbnRzOiB7XHJcbiAgICAgIG9uUmVhZHk6IG9uUGxheWVyUmVhZHksXHJcbiAgICAgIG9uU3RhdGVDaGFuZ2U6IG9uUGxheWVyU3RhdGVDaGFuZ2VcclxuICAgIH0sXHJcbiAgICBwbGF5ZXJWYXJzOiB7XHJcbiAgICAgIGNvbnRyb2xzOiAwLFxyXG4gICAgICBkaXNhYmxla2I6IDAsXHJcbiAgICAgIHNob3dpbmZvOiAwLFxyXG4gICAgICByZWw6IDAsXHJcbiAgICAgIGF1dG9wbGF5OiAwLFxyXG4gICAgICBtb2Rlc3RicmFuZGluZzogMFxyXG4gICAgfVxyXG4gIH0pO1xyXG59XHJcbmNvbnNvbGUubG9nKHBsYXllcik7XHJcblxyXG5ldmVudHNJbml0KCk7Il19
