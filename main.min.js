$(document).ready(function () {
  // We listen to the resize event

  let vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
  window.addEventListener('resize', () => {
    // We execute the same script as before
    let vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
  });

  // box slider
  $('.slidermenu__items').bxSlider();


  // fullscreen menu

  const hamburgerMenu = document.querySelector(".hamburger-menu-link");
  const fullScreenMenu = document.querySelector(".fullscreen-menu");
  const fullScreenMenuClose = document.querySelector(".fullscreen-menu__close");

  hamburgerMenu.addEventListener("click", function (e) {
    e.preventDefault();
    fullScreenMenu.style.display = "flex";
  });

  fullScreenMenuClose.addEventListener("click", function (e) {
    e.preventDefault();
    fullScreenMenu.style.display = "none";
  });

  $(".menu__link").on('click', e => {
    $(fullScreenMenu).css({ 'display': 'none' });
  })



  // team section
  let teamItems = $('.team__item');
  let teamItemLink = $('.team__link');

  $('.team__link').on('click', (e) => {
    e.preventDefault();

    $(e.currentTarget).closest('.team__item').toggleClass('team__item--active');
    $(e.currentTarget).closest('.team__item').siblings('.team__item').removeClass('team__item--active');
  })

  //burger menu

  $('.burgermenu__trigger').on('click', e => {
    e.preventDefault();
    let item = $(e.currentTarget);
    item.closest('.burgermenu__item').toggleClass('burgermenu__item--active');
    item.closest('.burgermenu__item').siblings('.burgermenu__item').removeClass('burgermenu__item--active');

    if ($('.burgermenu__item').hasClass('burgermenu__item--active')) {
      item.closest('.burgermenu__list').css('width', '100%');
    } else {
      item.closest('.burgermenu__list').css('width', 'auto');
    }
  });

  $('.burgermenu__close').on('click', e => {
    e.preventDefault();
    $('.burgermenu__trigger').click();
  });
  // order menu


  const orderForm = document.querySelector('.orderForm');
  const orderBtn = document.querySelector('#order__btn');

  orderBtn.addEventListener('click', (e) => {
    e.preventDefault();
    // console.log(orderForm.elements.name.value);
    if (validateForm(orderForm)) {
      // console.log('vsew ok');
      const data = {
        name: orderForm.elements.name.value,
        phone: orderForm.elements.phone.value,
        comment: orderForm.elements.comment.value,
        to: 'some-mail@mail.com' // По заданию сервер принимает четыре параметра, включая email. 
        // Но по макету в форме email он отсутствует.
      }
      const xhr = new XMLHttpRequest();
      xhr.responseType = 'json';
      xhr.open('POST', 'https://webdev-api.loftschool.com/sendmail');
      xhr.setRequestHeader('content-type', 'application/json');
      xhr.send(JSON.stringify(data));
      xhr.addEventListener('load', () => {
        console.log(xhr.response.message);
        overlayOrder.open();
        overlayOrder.setContent(xhr.response.message);
      });
    }
  });

  function validateForm(form) {
    let valid = true;

    if (!validateField(form.elements.name)) {
      valid = false;
    }

    if (!validateField(form.elements.phone)) {
      valid = false;
    }

    if (!validateField(form.elements.comment)) {
      valid = false;
    }

    return valid;
  }

  function validateField(field) {
    // field.nextElementSibling.textContent = field.validationMessage;
    if (field.checkValidity()) {
      $(field).css('border-color', 'transparent');
    } else {
      $(field).css('border-color', 'red');
    }
    return field.checkValidity();
  }


  //overlay

  // const openOverlay = document.querySelector('#openOverlay');
  const tamplateOrder = document.querySelector('#overlayOrder').innerHTML;
  const overlayOrder = createOverlay(tamplateOrder, 'tamplateOrder');

  // openOverlay.addEventListener('click', e => {
  //   overlay.open();
  //   overlay.setContent('Vse ok');
  // });

  function createOverlay(tamplate, classTamplate) {
    const fragment = document.createElement('div');
    fragment.innerHTML = tamplate;

    const overlayElement = fragment.querySelector('.overlay');
    const containerElement = fragment.querySelector('.overlay__container');
    containerElement.classList.add(classTamplate);
    const closeElement = fragment.querySelector('.overlay__close');
    const contentElement = fragment.querySelector('.overlay__content');

    overlayElement.addEventListener('click', e => {
      if (e.target === overlayElement) {
        closeElement.click();
      }
    });

    closeElement.addEventListener('click', (e) => {
      e.preventDefault();
      document.body.removeChild(overlayElement);
    })

    return {
      open() {
        document.body.appendChild(overlayElement);
      },
      close() {
        closeElement.click();
      },
      setContent(content) {
        contentElement.innerHTML = content;
      }
    }

  }

  // reviews 
  const tamplateReview = document.querySelector('#overlayReview').innerHTML;
  const overlayReview = createOverlay(tamplateReview);

  const reviewOverlayBtn = $('.review__btn');

  reviewOverlayBtn.on('click', e => {
    e.preventDefault();
    let reviewContent = $(e.currentTarget).siblings('.review__content').prop('outerHTML');

    overlayReview.open();
    overlayReview.setContent(reviewContent);
  })

  //one page scroll
  const sections = $('.section');
  const display = $('.maincontent');

  let inScroll = false; // есть ли перемещение


  const countSectionPosition = (sectionIndex) => {
    const position = sectionIndex * (-100);
    // console.log(position);
    if (isNaN(position)) {
      console.error("передано не верное значение в countSectionPositon");
    }
    return position;

  }

  const resetActiveClass = function (section, sectionIndex) {
    section.eq(sectionIndex).addClass('active').siblings().removeClass('active');
    $('.fixed-menu__item').eq(sectionIndex).addClass('active').siblings().removeClass('active');
  };


  const performTransition = (sectionIndex) => {
    if (inScroll) return; // проверяем , есть ли перемещение сейчас
    inScroll = true; //разрешаем перемещение
    //определяем позицию секции и расчитываем значение перемещения
    const position = countSectionPosition(sectionIndex);
    const trasitionOver = 500; // время задержки

    //меняем активный класс
    resetActiveClass(sections, sectionIndex);

    if ((sectionIndex - 1) === 6 || (sectionIndex + 1) === 6) {
      checkActivePlayer();
    }
    //перемещяем maincontent на указанную позицию
    display.css({
      transform: `translateY(${position}%)`,
    });

    //устанавливаем время задержки
    setTimeout(() => {
      inScroll = false; //запрещяем перемещение
      // resetActiveClass($(".fixed-menu__item"), sectionEq);
    }, trasitionOver);

  }

  const pageScroll = function () {
    const activeSection = sections.filter('.active');
    const nextSection = activeSection.next();
    const prevSection = activeSection.prev();

    return {
      next() {
        // есть ли секция снизу
        if (nextSection.length) {
          performTransition(nextSection.index());
        }
      },
      prev() {
        // есть ли секция сверху
        if (prevSection.length) {
          performTransition(prevSection.index());
        }
      }
    }

  };

  //обработка событий: 

  $(document).keydown(e => {
    const tagName = e.target.tagName.toLowerCase();
    const windowScroller = pageScroll();
    console.log(e.target);
    console.log(tagName);
    const userTypingInInputs = tagName === "input" || tagName === "textarea";

    if (userTypingInInputs) return;

    if (e.key === "ArrowDown") {
      windowScroller.next();
    } else if (e.key === "ArrowUp") {
      windowScroller.prev();
    } else if (e.keyCode === 32) {
      windowScroller.next();
    }

  });

  $('[scroll-to]').on('click', (e) => {
    e.preventDefault();
    // console.log(e.currentTarget);
    let menuIndex = $(e.currentTarget).attr('scroll-to');
    performTransition(menuIndex);
  });

  $(window).on("wheel", (e) => {
    const deltaY = e.originalEvent.deltaY;
    const windowScroller = pageScroll();

    if (deltaY > 0) {
      windowScroller.next();
    }

    if (deltaY < 0) {
      windowScroller.prev();
    }
  });

  $('.scroll-down').on('click', e => {
    e.preventDefault();
    performTransition(1);
  });



  /// http://hgoebl.github.io/mobile-detect.js/
  const md = new MobileDetect(window.navigator.userAgent);
  const isMobile = md.mobile();
  // console.log(isMobile);

  if (isMobile) {
    // http://github.com/mattbryson/TouchSwipe-Jquery-Plugin
    $("body").swipe({
      //Generic swipe handler for all directions
      swipe: function (event, direction, distance, duration, fingerCount, fingerData) {
        // console.log("You swiped " + direction );
        const windowScroller = pageScroll();

        if (direction === 'up') {
          // console.log('up');
          windowScroller.next();
        }

        if (direction === 'down') {
          // console.log('down');
          windowScroller.prev();
        }
      }
    });
  }
  //

  //

  // yandex map
  let myMap;

  const init = () => {
    myMap = new ymaps.Map("map", {
      center: [59.938951, 30.315635],
      zoom: 11,
      controls: []
    });

    //отключаем зум колёсиком мышки
    myMap.behaviors.disable('scrollZoom');

    //на мобильных устройствах... (проверяем по userAgent браузера)
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
      //... отключаем перетаскивание карты
      myMap.behaviors.disable('drag');
    }

    const coords = [
      [59.888834, 30.321793],
      [59.936620, 30.259454],
      [59.931454, 30.345764],
      [59.861381, 30.398845],
    ];
    const myCollection = new ymaps.GeoObjectCollection({}, {
      draggable: false,
      iconLayout: 'default#image',
      iconImageHref: './img/icons/map-marker.svg',
      iconImageSize: [46, 57],
      iconImageOffset: [-35, -52]
    });

    coords.forEach(coord => {
      myCollection.add(new ymaps.Placemark(coord));
    })

    myMap.geoObjects.add(myCollection);
    myMap.behaviors.disable('scrollZoom');
  };


  ymaps.ready(init);


}); //document ready


/// youtube player

let player;
const playerContainer = $(".player");



let eventsInit = () => {
  $(".player__start").click(e => {
    e.preventDefault();

    if (playerContainer.hasClass("paused")) {
      player.pauseVideo();
    } else {
      player.playVideo();
    }
  });

  $(".player__playback").click(e => {
    const bar = $(e.currentTarget);
    const clickedPosition = e.originalEvent.layerX;
    const newButtonPositionPercent = (clickedPosition / bar.width()) * 100;
    const newPlaybackPositionSec =
      (player.getDuration() / 100) * newButtonPositionPercent;

    $(".player__playback-button").css({
      left: `${newButtonPositionPercent}%`
    });

    player.seekTo(newPlaybackPositionSec);
  });

  $(".player__splash").click(e => {
    player.playVideo();
  })

  $(".player__volume-button").click(e => {
    if (player.isMuted()) {
      player.unMute();
      $(e.currentTarget).parent().removeClass("mute");
      $('.player__volume-level-button').css({
        left: `${(player.getVolume())}%`
      });
    } else {
      player.mute();
      $(e.currentTarget).parent().addClass("mute");
      $('.player__volume-level-button').css({
        left: 0
      });
    }
  });

  $('.player__volume-level').click(e => {
    const volumeLevel = $(e.currentTarget);
    const volumeLevelClickPosition = e.originalEvent.layerX;
    const newVolumeLevel = (volumeLevelClickPosition / volumeLevel.width()) * 100;
    player.setVolume(newVolumeLevel);

    if (newVolumeLevel === 0) {
      player.mute();
      $(".player__volume").addClass("mute");
      $('.player__volume-level-button').css({
        left: 0
      });
    } else {
      player.unMute();
      $(".player__volume").removeClass("mute");
      $('.player__volume-level-button').css({
        left: `${newVolumeLevel}%`
      });
    }
    // const newVolumeLevel = (player.getVolume())


  });

};

const formatTime = timeSec => {
  const roundTime = Math.round(timeSec);

  const minutes = addZero(Math.floor(roundTime / 60));
  const seconds = addZero(roundTime - minutes * 60);

  function addZero(num) {
    return num < 10 ? `0${num}` : num;
  }

  return `${minutes} : ${seconds}`;
};

const onPlayerReady = () => {
  let interval;
  const durationSec = player.getDuration();

  $(".player__duration-estimate").text(formatTime(durationSec));

  if (typeof interval !== "undefined") {
    clearInterval(interval);
  }

  interval = setInterval(() => {
    const completedSec = player.getCurrentTime();
    const completedPercent = (completedSec / durationSec) * 100;

    $(".player__playback-button").css({
      left: `${completedPercent}%`
    });

    $(".player__duration-completed").text(formatTime(completedSec));
  }, 1000);
};

const onPlayerStateChange = event => {
  /*
    -1 (воспроизведение видео не начато)
    0 (воспроизведение видео завершено)
    1 (воспроизведение)
    2 (пауза)
    3 (буферизация)
    5 (видео подают реплики).
  */
  switch (event.data) {
    case 1:
      playerContainer.addClass("active");
      playerContainer.addClass("paused");
      break;

    case 2:
      playerContainer.removeClass("active");
      playerContainer.removeClass("paused");
      break;
  }
};



let playerHeight = $('.player').outerHeight();
let playerWidth = $('.player').outerWidth();



function onYouTubeIframeAPIReady() {

  player = new YT.Player("yt-player", {
    height: playerHeight,
    width: playerWidth,
    videoId: "8paoyY8BTO0",
    events: {
      onReady: onPlayerReady,
      onStateChange: onPlayerStateChange
    },
    playerVars: {
      controls: 0,
      disablekb: 0,
      showinfo: 0,
      rel: 0,
      autoplay: 0,
      modestbranding: 0
    }
  });

}

function checkActivePlayer() {
  if (!($('.work').hasClass('active'))) {
    player.pauseVideo();
  }
}
eventsInit();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJtYWluLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIiQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uICgpIHtcclxuICAvLyBXZSBsaXN0ZW4gdG8gdGhlIHJlc2l6ZSBldmVudFxyXG5cclxuICBsZXQgdmggPSB3aW5kb3cuaW5uZXJIZWlnaHQgKiAwLjAxO1xyXG4gIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZS5zZXRQcm9wZXJ0eSgnLS12aCcsIGAke3ZofXB4YCk7XHJcbiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsICgpID0+IHtcclxuICAgIC8vIFdlIGV4ZWN1dGUgdGhlIHNhbWUgc2NyaXB0IGFzIGJlZm9yZVxyXG4gICAgbGV0IHZoID0gd2luZG93LmlubmVySGVpZ2h0ICogMC4wMTtcclxuICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZS5zZXRQcm9wZXJ0eSgnLS12aCcsIGAke3ZofXB4YCk7XHJcbiAgfSk7XHJcblxyXG4gIC8vIGJveCBzbGlkZXJcclxuICAkKCcuc2xpZGVybWVudV9faXRlbXMnKS5ieFNsaWRlcigpO1xyXG5cclxuXHJcbiAgLy8gZnVsbHNjcmVlbiBtZW51XHJcblxyXG4gIGNvbnN0IGhhbWJ1cmdlck1lbnUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLmhhbWJ1cmdlci1tZW51LWxpbmtcIik7XHJcbiAgY29uc3QgZnVsbFNjcmVlbk1lbnUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLmZ1bGxzY3JlZW4tbWVudVwiKTtcclxuICBjb25zdCBmdWxsU2NyZWVuTWVudUNsb3NlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5mdWxsc2NyZWVuLW1lbnVfX2Nsb3NlXCIpO1xyXG5cclxuICBoYW1idXJnZXJNZW51LmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBmdW5jdGlvbiAoZSkge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgZnVsbFNjcmVlbk1lbnUuc3R5bGUuZGlzcGxheSA9IFwiZmxleFwiO1xyXG4gIH0pO1xyXG5cclxuICBmdWxsU2NyZWVuTWVudUNsb3NlLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBmdW5jdGlvbiAoZSkge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgZnVsbFNjcmVlbk1lbnUuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xyXG4gIH0pO1xyXG5cclxuICAkKFwiLm1lbnVfX2xpbmtcIikub24oJ2NsaWNrJywgZSA9PiB7XHJcbiAgICAkKGZ1bGxTY3JlZW5NZW51KS5jc3MoeyAnZGlzcGxheSc6ICdub25lJyB9KTtcclxuICB9KVxyXG5cclxuXHJcblxyXG4gIC8vIHRlYW0gc2VjdGlvblxyXG4gIGxldCB0ZWFtSXRlbXMgPSAkKCcudGVhbV9faXRlbScpO1xyXG4gIGxldCB0ZWFtSXRlbUxpbmsgPSAkKCcudGVhbV9fbGluaycpO1xyXG5cclxuICAkKCcudGVhbV9fbGluaycpLm9uKCdjbGljaycsIChlKSA9PiB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcblxyXG4gICAgJChlLmN1cnJlbnRUYXJnZXQpLmNsb3Nlc3QoJy50ZWFtX19pdGVtJykudG9nZ2xlQ2xhc3MoJ3RlYW1fX2l0ZW0tLWFjdGl2ZScpO1xyXG4gICAgJChlLmN1cnJlbnRUYXJnZXQpLmNsb3Nlc3QoJy50ZWFtX19pdGVtJykuc2libGluZ3MoJy50ZWFtX19pdGVtJykucmVtb3ZlQ2xhc3MoJ3RlYW1fX2l0ZW0tLWFjdGl2ZScpO1xyXG4gIH0pXHJcblxyXG4gIC8vYnVyZ2VyIG1lbnVcclxuXHJcbiAgJCgnLmJ1cmdlcm1lbnVfX3RyaWdnZXInKS5vbignY2xpY2snLCBlID0+IHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgIGxldCBpdGVtID0gJChlLmN1cnJlbnRUYXJnZXQpO1xyXG4gICAgaXRlbS5jbG9zZXN0KCcuYnVyZ2VybWVudV9faXRlbScpLnRvZ2dsZUNsYXNzKCdidXJnZXJtZW51X19pdGVtLS1hY3RpdmUnKTtcclxuICAgIGl0ZW0uY2xvc2VzdCgnLmJ1cmdlcm1lbnVfX2l0ZW0nKS5zaWJsaW5ncygnLmJ1cmdlcm1lbnVfX2l0ZW0nKS5yZW1vdmVDbGFzcygnYnVyZ2VybWVudV9faXRlbS0tYWN0aXZlJyk7XHJcblxyXG4gICAgaWYgKCQoJy5idXJnZXJtZW51X19pdGVtJykuaGFzQ2xhc3MoJ2J1cmdlcm1lbnVfX2l0ZW0tLWFjdGl2ZScpKSB7XHJcbiAgICAgIGl0ZW0uY2xvc2VzdCgnLmJ1cmdlcm1lbnVfX2xpc3QnKS5jc3MoJ3dpZHRoJywgJzEwMCUnKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGl0ZW0uY2xvc2VzdCgnLmJ1cmdlcm1lbnVfX2xpc3QnKS5jc3MoJ3dpZHRoJywgJ2F1dG8nKTtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgJCgnLmJ1cmdlcm1lbnVfX2Nsb3NlJykub24oJ2NsaWNrJywgZSA9PiB7XHJcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAkKCcuYnVyZ2VybWVudV9fdHJpZ2dlcicpLmNsaWNrKCk7XHJcbiAgfSk7XHJcbiAgLy8gb3JkZXIgbWVudVxyXG5cclxuXHJcbiAgY29uc3Qgb3JkZXJGb3JtID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm9yZGVyRm9ybScpO1xyXG4gIGNvbnN0IG9yZGVyQnRuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI29yZGVyX19idG4nKTtcclxuXHJcbiAgb3JkZXJCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4ge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgLy8gY29uc29sZS5sb2cob3JkZXJGb3JtLmVsZW1lbnRzLm5hbWUudmFsdWUpO1xyXG4gICAgaWYgKHZhbGlkYXRlRm9ybShvcmRlckZvcm0pKSB7XHJcbiAgICAgIC8vIGNvbnNvbGUubG9nKCd2c2V3IG9rJyk7XHJcbiAgICAgIGNvbnN0IGRhdGEgPSB7XHJcbiAgICAgICAgbmFtZTogb3JkZXJGb3JtLmVsZW1lbnRzLm5hbWUudmFsdWUsXHJcbiAgICAgICAgcGhvbmU6IG9yZGVyRm9ybS5lbGVtZW50cy5waG9uZS52YWx1ZSxcclxuICAgICAgICBjb21tZW50OiBvcmRlckZvcm0uZWxlbWVudHMuY29tbWVudC52YWx1ZSxcclxuICAgICAgICB0bzogJ3NvbWUtbWFpbEBtYWlsLmNvbScgLy8g0J/QviDQt9Cw0LTQsNC90LjRjiDRgdC10YDQstC10YAg0L/RgNC40L3QuNC80LDQtdGCINGH0LXRgtGL0YDQtSDQv9Cw0YDQsNC80LXRgtGA0LAsINCy0LrQu9GO0YfQsNGPIGVtYWlsLiBcclxuICAgICAgICAvLyDQndC+INC/0L4g0LzQsNC60LXRgtGDINCyINGE0L7RgNC80LUgZW1haWwg0L7QvSDQvtGC0YHRg9GC0YHRgtCy0YPQtdGCLlxyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xyXG4gICAgICB4aHIucmVzcG9uc2VUeXBlID0gJ2pzb24nO1xyXG4gICAgICB4aHIub3BlbignUE9TVCcsICdodHRwczovL3dlYmRldi1hcGkubG9mdHNjaG9vbC5jb20vc2VuZG1haWwnKTtcclxuICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ2NvbnRlbnQtdHlwZScsICdhcHBsaWNhdGlvbi9qc29uJyk7XHJcbiAgICAgIHhoci5zZW5kKEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcclxuICAgICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCAoKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coeGhyLnJlc3BvbnNlLm1lc3NhZ2UpO1xyXG4gICAgICAgIG92ZXJsYXlPcmRlci5vcGVuKCk7XHJcbiAgICAgICAgb3ZlcmxheU9yZGVyLnNldENvbnRlbnQoeGhyLnJlc3BvbnNlLm1lc3NhZ2UpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgZnVuY3Rpb24gdmFsaWRhdGVGb3JtKGZvcm0pIHtcclxuICAgIGxldCB2YWxpZCA9IHRydWU7XHJcblxyXG4gICAgaWYgKCF2YWxpZGF0ZUZpZWxkKGZvcm0uZWxlbWVudHMubmFtZSkpIHtcclxuICAgICAgdmFsaWQgPSBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXZhbGlkYXRlRmllbGQoZm9ybS5lbGVtZW50cy5waG9uZSkpIHtcclxuICAgICAgdmFsaWQgPSBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXZhbGlkYXRlRmllbGQoZm9ybS5lbGVtZW50cy5jb21tZW50KSkge1xyXG4gICAgICB2YWxpZCA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB2YWxpZDtcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIHZhbGlkYXRlRmllbGQoZmllbGQpIHtcclxuICAgIC8vIGZpZWxkLm5leHRFbGVtZW50U2libGluZy50ZXh0Q29udGVudCA9IGZpZWxkLnZhbGlkYXRpb25NZXNzYWdlO1xyXG4gICAgaWYgKGZpZWxkLmNoZWNrVmFsaWRpdHkoKSkge1xyXG4gICAgICAkKGZpZWxkKS5jc3MoJ2JvcmRlci1jb2xvcicsICd0cmFuc3BhcmVudCcpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgJChmaWVsZCkuY3NzKCdib3JkZXItY29sb3InLCAncmVkJyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmllbGQuY2hlY2tWYWxpZGl0eSgpO1xyXG4gIH1cclxuXHJcblxyXG4gIC8vb3ZlcmxheVxyXG5cclxuICAvLyBjb25zdCBvcGVuT3ZlcmxheSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNvcGVuT3ZlcmxheScpO1xyXG4gIGNvbnN0IHRhbXBsYXRlT3JkZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjb3ZlcmxheU9yZGVyJykuaW5uZXJIVE1MO1xyXG4gIGNvbnN0IG92ZXJsYXlPcmRlciA9IGNyZWF0ZU92ZXJsYXkodGFtcGxhdGVPcmRlciwgJ3RhbXBsYXRlT3JkZXInKTtcclxuXHJcbiAgLy8gb3Blbk92ZXJsYXkuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHtcclxuICAvLyAgIG92ZXJsYXkub3BlbigpO1xyXG4gIC8vICAgb3ZlcmxheS5zZXRDb250ZW50KCdWc2Ugb2snKTtcclxuICAvLyB9KTtcclxuXHJcbiAgZnVuY3Rpb24gY3JlYXRlT3ZlcmxheSh0YW1wbGF0ZSwgY2xhc3NUYW1wbGF0ZSkge1xyXG4gICAgY29uc3QgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgIGZyYWdtZW50LmlubmVySFRNTCA9IHRhbXBsYXRlO1xyXG5cclxuICAgIGNvbnN0IG92ZXJsYXlFbGVtZW50ID0gZnJhZ21lbnQucXVlcnlTZWxlY3RvcignLm92ZXJsYXknKTtcclxuICAgIGNvbnN0IGNvbnRhaW5lckVsZW1lbnQgPSBmcmFnbWVudC5xdWVyeVNlbGVjdG9yKCcub3ZlcmxheV9fY29udGFpbmVyJyk7XHJcbiAgICBjb250YWluZXJFbGVtZW50LmNsYXNzTGlzdC5hZGQoY2xhc3NUYW1wbGF0ZSk7XHJcbiAgICBjb25zdCBjbG9zZUVsZW1lbnQgPSBmcmFnbWVudC5xdWVyeVNlbGVjdG9yKCcub3ZlcmxheV9fY2xvc2UnKTtcclxuICAgIGNvbnN0IGNvbnRlbnRFbGVtZW50ID0gZnJhZ21lbnQucXVlcnlTZWxlY3RvcignLm92ZXJsYXlfX2NvbnRlbnQnKTtcclxuXHJcbiAgICBvdmVybGF5RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGUgPT4ge1xyXG4gICAgICBpZiAoZS50YXJnZXQgPT09IG92ZXJsYXlFbGVtZW50KSB7XHJcbiAgICAgICAgY2xvc2VFbGVtZW50LmNsaWNrKCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIGNsb3NlRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XHJcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChvdmVybGF5RWxlbWVudCk7XHJcbiAgICB9KVxyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIG9wZW4oKSB7XHJcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChvdmVybGF5RWxlbWVudCk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGNsb3NlKCkge1xyXG4gICAgICAgIGNsb3NlRWxlbWVudC5jbGljaygpO1xyXG4gICAgICB9LFxyXG4gICAgICBzZXRDb250ZW50KGNvbnRlbnQpIHtcclxuICAgICAgICBjb250ZW50RWxlbWVudC5pbm5lckhUTUwgPSBjb250ZW50O1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gIH1cclxuXHJcbiAgLy8gcmV2aWV3cyBcclxuICBjb25zdCB0YW1wbGF0ZVJldmlldyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNvdmVybGF5UmV2aWV3JykuaW5uZXJIVE1MO1xyXG4gIGNvbnN0IG92ZXJsYXlSZXZpZXcgPSBjcmVhdGVPdmVybGF5KHRhbXBsYXRlUmV2aWV3KTtcclxuXHJcbiAgY29uc3QgcmV2aWV3T3ZlcmxheUJ0biA9ICQoJy5yZXZpZXdfX2J0bicpO1xyXG5cclxuICByZXZpZXdPdmVybGF5QnRuLm9uKCdjbGljaycsIGUgPT4ge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgbGV0IHJldmlld0NvbnRlbnQgPSAkKGUuY3VycmVudFRhcmdldCkuc2libGluZ3MoJy5yZXZpZXdfX2NvbnRlbnQnKS5wcm9wKCdvdXRlckhUTUwnKTtcclxuXHJcbiAgICBvdmVybGF5UmV2aWV3Lm9wZW4oKTtcclxuICAgIG92ZXJsYXlSZXZpZXcuc2V0Q29udGVudChyZXZpZXdDb250ZW50KTtcclxuICB9KVxyXG5cclxuICAvL29uZSBwYWdlIHNjcm9sbFxyXG4gIGNvbnN0IHNlY3Rpb25zID0gJCgnLnNlY3Rpb24nKTtcclxuICBjb25zdCBkaXNwbGF5ID0gJCgnLm1haW5jb250ZW50Jyk7XHJcblxyXG4gIGxldCBpblNjcm9sbCA9IGZhbHNlOyAvLyDQtdGB0YLRjCDQu9C4INC/0LXRgNC10LzQtdGJ0LXQvdC40LVcclxuXHJcblxyXG4gIGNvbnN0IGNvdW50U2VjdGlvblBvc2l0aW9uID0gKHNlY3Rpb25JbmRleCkgPT4ge1xyXG4gICAgY29uc3QgcG9zaXRpb24gPSBzZWN0aW9uSW5kZXggKiAoLTEwMCk7XHJcbiAgICAvLyBjb25zb2xlLmxvZyhwb3NpdGlvbik7XHJcbiAgICBpZiAoaXNOYU4ocG9zaXRpb24pKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCLQv9C10YDQtdC00LDQvdC+INC90LUg0LLQtdGA0L3QvtC1INC30L3QsNGH0LXQvdC40LUg0LIgY291bnRTZWN0aW9uUG9zaXRvblwiKTtcclxuICAgIH1cclxuICAgIHJldHVybiBwb3NpdGlvbjtcclxuXHJcbiAgfVxyXG5cclxuICBjb25zdCByZXNldEFjdGl2ZUNsYXNzID0gZnVuY3Rpb24gKHNlY3Rpb24sIHNlY3Rpb25JbmRleCkge1xyXG4gICAgc2VjdGlvbi5lcShzZWN0aW9uSW5kZXgpLmFkZENsYXNzKCdhY3RpdmUnKS5zaWJsaW5ncygpLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTtcclxuICAgICQoJy5maXhlZC1tZW51X19pdGVtJykuZXEoc2VjdGlvbkluZGV4KS5hZGRDbGFzcygnYWN0aXZlJykuc2libGluZ3MoKS5yZW1vdmVDbGFzcygnYWN0aXZlJyk7XHJcbiAgfTtcclxuXHJcblxyXG4gIGNvbnN0IHBlcmZvcm1UcmFuc2l0aW9uID0gKHNlY3Rpb25JbmRleCkgPT4ge1xyXG4gICAgaWYgKGluU2Nyb2xsKSByZXR1cm47IC8vINC/0YDQvtCy0LXRgNGP0LXQvCAsINC10YHRgtGMINC70Lgg0L/QtdGA0LXQvNC10YnQtdC90LjQtSDRgdC10LnRh9Cw0YFcclxuICAgIGluU2Nyb2xsID0gdHJ1ZTsgLy/RgNCw0LfRgNC10YjQsNC10Lwg0L/QtdGA0LXQvNC10YnQtdC90LjQtVxyXG4gICAgLy/QvtC/0YDQtdC00LXQu9GP0LXQvCDQv9C+0LfQuNGG0LjRjiDRgdC10LrRhtC40Lgg0Lgg0YDQsNGB0YfQuNGC0YvQstCw0LXQvCDQt9C90LDRh9C10L3QuNC1INC/0LXRgNC10LzQtdGJ0LXQvdC40Y9cclxuICAgIGNvbnN0IHBvc2l0aW9uID0gY291bnRTZWN0aW9uUG9zaXRpb24oc2VjdGlvbkluZGV4KTtcclxuICAgIGNvbnN0IHRyYXNpdGlvbk92ZXIgPSA1MDA7IC8vINCy0YDQtdC80Y8g0LfQsNC00LXRgNC20LrQuFxyXG5cclxuICAgIC8v0LzQtdC90Y/QtdC8INCw0LrRgtC40LLQvdGL0Lkg0LrQu9Cw0YHRgVxyXG4gICAgcmVzZXRBY3RpdmVDbGFzcyhzZWN0aW9ucywgc2VjdGlvbkluZGV4KTtcclxuXHJcbiAgICBpZiAoKHNlY3Rpb25JbmRleCAtIDEpID09PSA2IHx8IChzZWN0aW9uSW5kZXggKyAxKSA9PT0gNikge1xyXG4gICAgICBjaGVja0FjdGl2ZVBsYXllcigpO1xyXG4gICAgfVxyXG4gICAgLy/Qv9C10YDQtdC80LXRidGP0LXQvCBtYWluY29udGVudCDQvdCwINGD0LrQsNC30LDQvdC90YPRjiDQv9C+0LfQuNGG0LjRjlxyXG4gICAgZGlzcGxheS5jc3Moe1xyXG4gICAgICB0cmFuc2Zvcm06IGB0cmFuc2xhdGVZKCR7cG9zaXRpb259JSlgLFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy/Rg9GB0YLQsNC90LDQstC70LjQstCw0LXQvCDQstGA0LXQvNGPINC30LDQtNC10YDQttC60LhcclxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICBpblNjcm9sbCA9IGZhbHNlOyAvL9C30LDQv9GA0LXRidGP0LXQvCDQv9C10YDQtdC80LXRidC10L3QuNC1XHJcbiAgICAgIC8vIHJlc2V0QWN0aXZlQ2xhc3MoJChcIi5maXhlZC1tZW51X19pdGVtXCIpLCBzZWN0aW9uRXEpO1xyXG4gICAgfSwgdHJhc2l0aW9uT3Zlcik7XHJcblxyXG4gIH1cclxuXHJcbiAgY29uc3QgcGFnZVNjcm9sbCA9IGZ1bmN0aW9uICgpIHtcclxuICAgIGNvbnN0IGFjdGl2ZVNlY3Rpb24gPSBzZWN0aW9ucy5maWx0ZXIoJy5hY3RpdmUnKTtcclxuICAgIGNvbnN0IG5leHRTZWN0aW9uID0gYWN0aXZlU2VjdGlvbi5uZXh0KCk7XHJcbiAgICBjb25zdCBwcmV2U2VjdGlvbiA9IGFjdGl2ZVNlY3Rpb24ucHJldigpO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIG5leHQoKSB7XHJcbiAgICAgICAgLy8g0LXRgdGC0Ywg0LvQuCDRgdC10LrRhtC40Y8g0YHQvdC40LfRg1xyXG4gICAgICAgIGlmIChuZXh0U2VjdGlvbi5sZW5ndGgpIHtcclxuICAgICAgICAgIHBlcmZvcm1UcmFuc2l0aW9uKG5leHRTZWN0aW9uLmluZGV4KCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuICAgICAgcHJldigpIHtcclxuICAgICAgICAvLyDQtdGB0YLRjCDQu9C4INGB0LXQutGG0LjRjyDRgdCy0LXRgNGF0YNcclxuICAgICAgICBpZiAocHJldlNlY3Rpb24ubGVuZ3RoKSB7XHJcbiAgICAgICAgICBwZXJmb3JtVHJhbnNpdGlvbihwcmV2U2VjdGlvbi5pbmRleCgpKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgfTtcclxuXHJcbiAgLy/QvtCx0YDQsNCx0L7RgtC60LAg0YHQvtCx0YvRgtC40Lk6IFxyXG5cclxuICAkKGRvY3VtZW50KS5rZXlkb3duKGUgPT4ge1xyXG4gICAgY29uc3QgdGFnTmFtZSA9IGUudGFyZ2V0LnRhZ05hbWUudG9Mb3dlckNhc2UoKTtcclxuICAgIGNvbnN0IHdpbmRvd1Njcm9sbGVyID0gcGFnZVNjcm9sbCgpO1xyXG4gICAgY29uc29sZS5sb2coZS50YXJnZXQpO1xyXG4gICAgY29uc29sZS5sb2codGFnTmFtZSk7XHJcbiAgICBjb25zdCB1c2VyVHlwaW5nSW5JbnB1dHMgPSB0YWdOYW1lID09PSBcImlucHV0XCIgfHwgdGFnTmFtZSA9PT0gXCJ0ZXh0YXJlYVwiO1xyXG5cclxuICAgIGlmICh1c2VyVHlwaW5nSW5JbnB1dHMpIHJldHVybjtcclxuXHJcbiAgICBpZiAoZS5rZXkgPT09IFwiQXJyb3dEb3duXCIpIHtcclxuICAgICAgd2luZG93U2Nyb2xsZXIubmV4dCgpO1xyXG4gICAgfSBlbHNlIGlmIChlLmtleSA9PT0gXCJBcnJvd1VwXCIpIHtcclxuICAgICAgd2luZG93U2Nyb2xsZXIucHJldigpO1xyXG4gICAgfSBlbHNlIGlmIChlLmtleUNvZGUgPT09IDMyKSB7XHJcbiAgICAgIHdpbmRvd1Njcm9sbGVyLm5leHQoKTtcclxuICAgIH1cclxuXHJcbiAgfSk7XHJcblxyXG4gICQoJ1tzY3JvbGwtdG9dJykub24oJ2NsaWNrJywgKGUpID0+IHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgIC8vIGNvbnNvbGUubG9nKGUuY3VycmVudFRhcmdldCk7XHJcbiAgICBsZXQgbWVudUluZGV4ID0gJChlLmN1cnJlbnRUYXJnZXQpLmF0dHIoJ3Njcm9sbC10bycpO1xyXG4gICAgcGVyZm9ybVRyYW5zaXRpb24obWVudUluZGV4KTtcclxuICB9KTtcclxuXHJcbiAgJCh3aW5kb3cpLm9uKFwid2hlZWxcIiwgKGUpID0+IHtcclxuICAgIGNvbnN0IGRlbHRhWSA9IGUub3JpZ2luYWxFdmVudC5kZWx0YVk7XHJcbiAgICBjb25zdCB3aW5kb3dTY3JvbGxlciA9IHBhZ2VTY3JvbGwoKTtcclxuXHJcbiAgICBpZiAoZGVsdGFZID4gMCkge1xyXG4gICAgICB3aW5kb3dTY3JvbGxlci5uZXh0KCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGRlbHRhWSA8IDApIHtcclxuICAgICAgd2luZG93U2Nyb2xsZXIucHJldigpO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICAkKCcuc2Nyb2xsLWRvd24nKS5vbignY2xpY2snLCBlID0+IHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgIHBlcmZvcm1UcmFuc2l0aW9uKDEpO1xyXG4gIH0pO1xyXG5cclxuXHJcblxyXG4gIC8vLyBodHRwOi8vaGdvZWJsLmdpdGh1Yi5pby9tb2JpbGUtZGV0ZWN0LmpzL1xyXG4gIGNvbnN0IG1kID0gbmV3IE1vYmlsZURldGVjdCh3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudCk7XHJcbiAgY29uc3QgaXNNb2JpbGUgPSBtZC5tb2JpbGUoKTtcclxuICAvLyBjb25zb2xlLmxvZyhpc01vYmlsZSk7XHJcblxyXG4gIGlmIChpc01vYmlsZSkge1xyXG4gICAgLy8gaHR0cDovL2dpdGh1Yi5jb20vbWF0dGJyeXNvbi9Ub3VjaFN3aXBlLUpxdWVyeS1QbHVnaW5cclxuICAgICQoXCJib2R5XCIpLnN3aXBlKHtcclxuICAgICAgLy9HZW5lcmljIHN3aXBlIGhhbmRsZXIgZm9yIGFsbCBkaXJlY3Rpb25zXHJcbiAgICAgIHN3aXBlOiBmdW5jdGlvbiAoZXZlbnQsIGRpcmVjdGlvbiwgZGlzdGFuY2UsIGR1cmF0aW9uLCBmaW5nZXJDb3VudCwgZmluZ2VyRGF0YSkge1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKFwiWW91IHN3aXBlZCBcIiArIGRpcmVjdGlvbiApO1xyXG4gICAgICAgIGNvbnN0IHdpbmRvd1Njcm9sbGVyID0gcGFnZVNjcm9sbCgpO1xyXG5cclxuICAgICAgICBpZiAoZGlyZWN0aW9uID09PSAndXAnKSB7XHJcbiAgICAgICAgICAvLyBjb25zb2xlLmxvZygndXAnKTtcclxuICAgICAgICAgIHdpbmRvd1Njcm9sbGVyLm5leHQoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChkaXJlY3Rpb24gPT09ICdkb3duJykge1xyXG4gICAgICAgICAgLy8gY29uc29sZS5sb2coJ2Rvd24nKTtcclxuICAgICAgICAgIHdpbmRvd1Njcm9sbGVyLnByZXYoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICAvL1xyXG5cclxuICAvL1xyXG5cclxuICAvLyB5YW5kZXggbWFwXHJcbiAgbGV0IG15TWFwO1xyXG5cclxuICBjb25zdCBpbml0ID0gKCkgPT4ge1xyXG4gICAgbXlNYXAgPSBuZXcgeW1hcHMuTWFwKFwibWFwXCIsIHtcclxuICAgICAgY2VudGVyOiBbNTkuOTM4OTUxLCAzMC4zMTU2MzVdLFxyXG4gICAgICB6b29tOiAxMSxcclxuICAgICAgY29udHJvbHM6IFtdXHJcbiAgICB9KTtcclxuXHJcbiAgICAvL9C+0YLQutC70Y7Rh9Cw0LXQvCDQt9GD0Lwg0LrQvtC70ZHRgdC40LrQvtC8INC80YvRiNC60LhcclxuICAgIG15TWFwLmJlaGF2aW9ycy5kaXNhYmxlKCdzY3JvbGxab29tJyk7XHJcblxyXG4gICAgLy/QvdCwINC80L7QsdC40LvRjNC90YvRhSDRg9GB0YLRgNC+0LnRgdGC0LLQsNGFLi4uICjQv9GA0L7QstC10YDRj9C10Lwg0L/QviB1c2VyQWdlbnQg0LHRgNCw0YPQt9C10YDQsClcclxuICAgIGlmICgvQW5kcm9pZHx3ZWJPU3xpUGhvbmV8aVBhZHxpUG9kfEJsYWNrQmVycnl8SUVNb2JpbGV8T3BlcmEgTWluaS9pLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCkpIHtcclxuICAgICAgLy8uLi4g0L7RgtC60LvRjtGH0LDQtdC8INC/0LXRgNC10YLQsNGB0LrQuNCy0LDQvdC40LUg0LrQsNGA0YLRi1xyXG4gICAgICBteU1hcC5iZWhhdmlvcnMuZGlzYWJsZSgnZHJhZycpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGNvb3JkcyA9IFtcclxuICAgICAgWzU5Ljg4ODgzNCwgMzAuMzIxNzkzXSxcclxuICAgICAgWzU5LjkzNjYyMCwgMzAuMjU5NDU0XSxcclxuICAgICAgWzU5LjkzMTQ1NCwgMzAuMzQ1NzY0XSxcclxuICAgICAgWzU5Ljg2MTM4MSwgMzAuMzk4ODQ1XSxcclxuICAgIF07XHJcbiAgICBjb25zdCBteUNvbGxlY3Rpb24gPSBuZXcgeW1hcHMuR2VvT2JqZWN0Q29sbGVjdGlvbih7fSwge1xyXG4gICAgICBkcmFnZ2FibGU6IGZhbHNlLFxyXG4gICAgICBpY29uTGF5b3V0OiAnZGVmYXVsdCNpbWFnZScsXHJcbiAgICAgIGljb25JbWFnZUhyZWY6ICcuL2ltZy9pY29ucy9tYXAtbWFya2VyLnN2ZycsXHJcbiAgICAgIGljb25JbWFnZVNpemU6IFs0NiwgNTddLFxyXG4gICAgICBpY29uSW1hZ2VPZmZzZXQ6IFstMzUsIC01Ml1cclxuICAgIH0pO1xyXG5cclxuICAgIGNvb3Jkcy5mb3JFYWNoKGNvb3JkID0+IHtcclxuICAgICAgbXlDb2xsZWN0aW9uLmFkZChuZXcgeW1hcHMuUGxhY2VtYXJrKGNvb3JkKSk7XHJcbiAgICB9KVxyXG5cclxuICAgIG15TWFwLmdlb09iamVjdHMuYWRkKG15Q29sbGVjdGlvbik7XHJcbiAgICBteU1hcC5iZWhhdmlvcnMuZGlzYWJsZSgnc2Nyb2xsWm9vbScpO1xyXG4gIH07XHJcblxyXG5cclxuICB5bWFwcy5yZWFkeShpbml0KTtcclxuXHJcblxyXG59KTsgLy9kb2N1bWVudCByZWFkeVxyXG5cclxuXHJcbi8vLyB5b3V0dWJlIHBsYXllclxyXG5cclxubGV0IHBsYXllcjtcclxuY29uc3QgcGxheWVyQ29udGFpbmVyID0gJChcIi5wbGF5ZXJcIik7XHJcblxyXG5cclxuXHJcbmxldCBldmVudHNJbml0ID0gKCkgPT4ge1xyXG4gICQoXCIucGxheWVyX19zdGFydFwiKS5jbGljayhlID0+IHtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuXHJcbiAgICBpZiAocGxheWVyQ29udGFpbmVyLmhhc0NsYXNzKFwicGF1c2VkXCIpKSB7XHJcbiAgICAgIHBsYXllci5wYXVzZVZpZGVvKCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBwbGF5ZXIucGxheVZpZGVvKCk7XHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gICQoXCIucGxheWVyX19wbGF5YmFja1wiKS5jbGljayhlID0+IHtcclxuICAgIGNvbnN0IGJhciA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcclxuICAgIGNvbnN0IGNsaWNrZWRQb3NpdGlvbiA9IGUub3JpZ2luYWxFdmVudC5sYXllclg7XHJcbiAgICBjb25zdCBuZXdCdXR0b25Qb3NpdGlvblBlcmNlbnQgPSAoY2xpY2tlZFBvc2l0aW9uIC8gYmFyLndpZHRoKCkpICogMTAwO1xyXG4gICAgY29uc3QgbmV3UGxheWJhY2tQb3NpdGlvblNlYyA9XHJcbiAgICAgIChwbGF5ZXIuZ2V0RHVyYXRpb24oKSAvIDEwMCkgKiBuZXdCdXR0b25Qb3NpdGlvblBlcmNlbnQ7XHJcblxyXG4gICAgJChcIi5wbGF5ZXJfX3BsYXliYWNrLWJ1dHRvblwiKS5jc3Moe1xyXG4gICAgICBsZWZ0OiBgJHtuZXdCdXR0b25Qb3NpdGlvblBlcmNlbnR9JWBcclxuICAgIH0pO1xyXG5cclxuICAgIHBsYXllci5zZWVrVG8obmV3UGxheWJhY2tQb3NpdGlvblNlYyk7XHJcbiAgfSk7XHJcblxyXG4gICQoXCIucGxheWVyX19zcGxhc2hcIikuY2xpY2soZSA9PiB7XHJcbiAgICBwbGF5ZXIucGxheVZpZGVvKCk7XHJcbiAgfSlcclxuXHJcbiAgJChcIi5wbGF5ZXJfX3ZvbHVtZS1idXR0b25cIikuY2xpY2soZSA9PiB7XHJcbiAgICBpZiAocGxheWVyLmlzTXV0ZWQoKSkge1xyXG4gICAgICBwbGF5ZXIudW5NdXRlKCk7XHJcbiAgICAgICQoZS5jdXJyZW50VGFyZ2V0KS5wYXJlbnQoKS5yZW1vdmVDbGFzcyhcIm11dGVcIik7XHJcbiAgICAgICQoJy5wbGF5ZXJfX3ZvbHVtZS1sZXZlbC1idXR0b24nKS5jc3Moe1xyXG4gICAgICAgIGxlZnQ6IGAkeyhwbGF5ZXIuZ2V0Vm9sdW1lKCkpfSVgXHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcGxheWVyLm11dGUoKTtcclxuICAgICAgJChlLmN1cnJlbnRUYXJnZXQpLnBhcmVudCgpLmFkZENsYXNzKFwibXV0ZVwiKTtcclxuICAgICAgJCgnLnBsYXllcl9fdm9sdW1lLWxldmVsLWJ1dHRvbicpLmNzcyh7XHJcbiAgICAgICAgbGVmdDogMFxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgJCgnLnBsYXllcl9fdm9sdW1lLWxldmVsJykuY2xpY2soZSA9PiB7XHJcbiAgICBjb25zdCB2b2x1bWVMZXZlbCA9ICQoZS5jdXJyZW50VGFyZ2V0KTtcclxuICAgIGNvbnN0IHZvbHVtZUxldmVsQ2xpY2tQb3NpdGlvbiA9IGUub3JpZ2luYWxFdmVudC5sYXllclg7XHJcbiAgICBjb25zdCBuZXdWb2x1bWVMZXZlbCA9ICh2b2x1bWVMZXZlbENsaWNrUG9zaXRpb24gLyB2b2x1bWVMZXZlbC53aWR0aCgpKSAqIDEwMDtcclxuICAgIHBsYXllci5zZXRWb2x1bWUobmV3Vm9sdW1lTGV2ZWwpO1xyXG5cclxuICAgIGlmIChuZXdWb2x1bWVMZXZlbCA9PT0gMCkge1xyXG4gICAgICBwbGF5ZXIubXV0ZSgpO1xyXG4gICAgICAkKFwiLnBsYXllcl9fdm9sdW1lXCIpLmFkZENsYXNzKFwibXV0ZVwiKTtcclxuICAgICAgJCgnLnBsYXllcl9fdm9sdW1lLWxldmVsLWJ1dHRvbicpLmNzcyh7XHJcbiAgICAgICAgbGVmdDogMFxyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHBsYXllci51bk11dGUoKTtcclxuICAgICAgJChcIi5wbGF5ZXJfX3ZvbHVtZVwiKS5yZW1vdmVDbGFzcyhcIm11dGVcIik7XHJcbiAgICAgICQoJy5wbGF5ZXJfX3ZvbHVtZS1sZXZlbC1idXR0b24nKS5jc3Moe1xyXG4gICAgICAgIGxlZnQ6IGAke25ld1ZvbHVtZUxldmVsfSVgXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgLy8gY29uc3QgbmV3Vm9sdW1lTGV2ZWwgPSAocGxheWVyLmdldFZvbHVtZSgpKVxyXG5cclxuXHJcbiAgfSk7XHJcblxyXG59O1xyXG5cclxuY29uc3QgZm9ybWF0VGltZSA9IHRpbWVTZWMgPT4ge1xyXG4gIGNvbnN0IHJvdW5kVGltZSA9IE1hdGgucm91bmQodGltZVNlYyk7XHJcblxyXG4gIGNvbnN0IG1pbnV0ZXMgPSBhZGRaZXJvKE1hdGguZmxvb3Iocm91bmRUaW1lIC8gNjApKTtcclxuICBjb25zdCBzZWNvbmRzID0gYWRkWmVybyhyb3VuZFRpbWUgLSBtaW51dGVzICogNjApO1xyXG5cclxuICBmdW5jdGlvbiBhZGRaZXJvKG51bSkge1xyXG4gICAgcmV0dXJuIG51bSA8IDEwID8gYDAke251bX1gIDogbnVtO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGAke21pbnV0ZXN9IDogJHtzZWNvbmRzfWA7XHJcbn07XHJcblxyXG5jb25zdCBvblBsYXllclJlYWR5ID0gKCkgPT4ge1xyXG4gIGxldCBpbnRlcnZhbDtcclxuICBjb25zdCBkdXJhdGlvblNlYyA9IHBsYXllci5nZXREdXJhdGlvbigpO1xyXG5cclxuICAkKFwiLnBsYXllcl9fZHVyYXRpb24tZXN0aW1hdGVcIikudGV4dChmb3JtYXRUaW1lKGR1cmF0aW9uU2VjKSk7XHJcblxyXG4gIGlmICh0eXBlb2YgaW50ZXJ2YWwgIT09IFwidW5kZWZpbmVkXCIpIHtcclxuICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWwpO1xyXG4gIH1cclxuXHJcbiAgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XHJcbiAgICBjb25zdCBjb21wbGV0ZWRTZWMgPSBwbGF5ZXIuZ2V0Q3VycmVudFRpbWUoKTtcclxuICAgIGNvbnN0IGNvbXBsZXRlZFBlcmNlbnQgPSAoY29tcGxldGVkU2VjIC8gZHVyYXRpb25TZWMpICogMTAwO1xyXG5cclxuICAgICQoXCIucGxheWVyX19wbGF5YmFjay1idXR0b25cIikuY3NzKHtcclxuICAgICAgbGVmdDogYCR7Y29tcGxldGVkUGVyY2VudH0lYFxyXG4gICAgfSk7XHJcblxyXG4gICAgJChcIi5wbGF5ZXJfX2R1cmF0aW9uLWNvbXBsZXRlZFwiKS50ZXh0KGZvcm1hdFRpbWUoY29tcGxldGVkU2VjKSk7XHJcbiAgfSwgMTAwMCk7XHJcbn07XHJcblxyXG5jb25zdCBvblBsYXllclN0YXRlQ2hhbmdlID0gZXZlbnQgPT4ge1xyXG4gIC8qXHJcbiAgICAtMSAo0LLQvtGB0L/RgNC+0LjQt9Cy0LXQtNC10L3QuNC1INCy0LjQtNC10L4g0L3QtSDQvdCw0YfQsNGC0L4pXHJcbiAgICAwICjQstC+0YHQv9GA0L7QuNC30LLQtdC00LXQvdC40LUg0LLQuNC00LXQviDQt9Cw0LLQtdGA0YjQtdC90L4pXHJcbiAgICAxICjQstC+0YHQv9GA0L7QuNC30LLQtdC00LXQvdC40LUpXHJcbiAgICAyICjQv9Cw0YPQt9CwKVxyXG4gICAgMyAo0LHRg9GE0LXRgNC40LfQsNGG0LjRjylcclxuICAgIDUgKNCy0LjQtNC10L4g0L/QvtC00LDRjtGCINGA0LXQv9C70LjQutC4KS5cclxuICAqL1xyXG4gIHN3aXRjaCAoZXZlbnQuZGF0YSkge1xyXG4gICAgY2FzZSAxOlxyXG4gICAgICBwbGF5ZXJDb250YWluZXIuYWRkQ2xhc3MoXCJhY3RpdmVcIik7XHJcbiAgICAgIHBsYXllckNvbnRhaW5lci5hZGRDbGFzcyhcInBhdXNlZFwiKTtcclxuICAgICAgYnJlYWs7XHJcblxyXG4gICAgY2FzZSAyOlxyXG4gICAgICBwbGF5ZXJDb250YWluZXIucmVtb3ZlQ2xhc3MoXCJhY3RpdmVcIik7XHJcbiAgICAgIHBsYXllckNvbnRhaW5lci5yZW1vdmVDbGFzcyhcInBhdXNlZFwiKTtcclxuICAgICAgYnJlYWs7XHJcbiAgfVxyXG59O1xyXG5cclxuXHJcblxyXG5sZXQgcGxheWVySGVpZ2h0ID0gJCgnLnBsYXllcicpLm91dGVySGVpZ2h0KCk7XHJcbmxldCBwbGF5ZXJXaWR0aCA9ICQoJy5wbGF5ZXInKS5vdXRlcldpZHRoKCk7XHJcblxyXG5cclxuXHJcbmZ1bmN0aW9uIG9uWW91VHViZUlmcmFtZUFQSVJlYWR5KCkge1xyXG5cclxuICBwbGF5ZXIgPSBuZXcgWVQuUGxheWVyKFwieXQtcGxheWVyXCIsIHtcclxuICAgIGhlaWdodDogcGxheWVySGVpZ2h0LFxyXG4gICAgd2lkdGg6IHBsYXllcldpZHRoLFxyXG4gICAgdmlkZW9JZDogXCI4cGFveVk4QlRPMFwiLFxyXG4gICAgZXZlbnRzOiB7XHJcbiAgICAgIG9uUmVhZHk6IG9uUGxheWVyUmVhZHksXHJcbiAgICAgIG9uU3RhdGVDaGFuZ2U6IG9uUGxheWVyU3RhdGVDaGFuZ2VcclxuICAgIH0sXHJcbiAgICBwbGF5ZXJWYXJzOiB7XHJcbiAgICAgIGNvbnRyb2xzOiAwLFxyXG4gICAgICBkaXNhYmxla2I6IDAsXHJcbiAgICAgIHNob3dpbmZvOiAwLFxyXG4gICAgICByZWw6IDAsXHJcbiAgICAgIGF1dG9wbGF5OiAwLFxyXG4gICAgICBtb2Rlc3RicmFuZGluZzogMFxyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxufVxyXG5cclxuZnVuY3Rpb24gY2hlY2tBY3RpdmVQbGF5ZXIoKSB7XHJcbiAgaWYgKCEoJCgnLndvcmsnKS5oYXNDbGFzcygnYWN0aXZlJykpKSB7XHJcbiAgICBwbGF5ZXIucGF1c2VWaWRlbygpO1xyXG4gIH1cclxufVxyXG5ldmVudHNJbml0KCk7XHJcblxyXG4iXX0=
